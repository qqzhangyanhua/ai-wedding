# MinIO é›†æˆå®Œæˆæ€»ç»“

## âœ… é›†æˆçŠ¶æ€ï¼šå·²å®Œæˆ

æœ¬æ¬¡æˆåŠŸå°†å›¾ç‰‡å­˜å‚¨ä» base64 è¿ç§»åˆ° MinIO å¯¹è±¡å­˜å‚¨ç³»ç»Ÿã€‚æ‰€æœ‰åŠŸèƒ½å·²å®ç°å¹¶é€šè¿‡æµ‹è¯•ã€‚

---

## ğŸ“¦ å·²å®Œæˆçš„å·¥ä½œ

### 1. âœ… å®‰è£… MinIO SDK å¹¶åˆ›å»ºå·¥å…·ç±»
**æ–‡ä»¶**: `lib/minio-client.ts`

**åŠŸèƒ½**:
- MinIO å®¢æˆ·ç«¯å•ä¾‹æ¨¡å¼
- è‡ªåŠ¨åˆ›å»ºå’Œé…ç½® bucket
- ä¸Šä¼ å›¾ç‰‡ï¼ˆæ”¯æŒ Bufferã€base64ã€dataURLï¼‰
- åˆ é™¤å›¾ç‰‡ï¼ˆå•ä¸ªå’Œæ‰¹é‡ï¼‰
- ç”Ÿæˆé¢„ç­¾å URL
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—

**é…ç½®**ï¼ˆæ¥è‡ª `.env`ï¼‰:
```env
MINIO_ENDPOINT="http://123.57.16.107:9000"
MINIO_ACCESS_KEY="minioadmin"
MINIO_SECRET_KEY="minioadmin"
MINIO_BUCKET_NAME="ai-images"
MINIO_USE_SSL="false"
```

---

### 2. âœ… åˆ›å»ºå›¾ç‰‡ä¸Šä¼  API
**æ–‡ä»¶**: `app/api/upload-image/route.ts`

**åŠŸèƒ½**:
- æ”¯æŒ JSON æ ¼å¼ï¼ˆbase64/dataURLï¼‰
- æ”¯æŒ FormData æ ¼å¼ï¼ˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼‰
- å¯é€‰çš„ç”¨æˆ·è®¤è¯
- è‡ªåŠ¨åˆ†æ–‡ä»¶å¤¹å­˜å‚¨ï¼ˆuploads/ã€generated/ ç­‰ï¼‰

**API ä½¿ç”¨ç¤ºä¾‹**:
```javascript
// JSON æ ¼å¼ä¸Šä¼ 
const response = await fetch('/api/upload-image', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    image: 'data:image/png;base64,...',
    folder: 'uploads'
  })
});

const result = await response.json();
// {
//   "success": true,
//   "url": "http://123.57.16.107:9000/ai-images/uploads/xxx.png",
//   "objectName": "uploads/xxx.png",
//   "bucket": "ai-images"
// }
```

---

### 3. âœ… ä¿®æ”¹ PhotoUploader ç»„ä»¶
**æ–‡ä»¶**: `src/components/PhotoUploader.tsx`

**æ”¹è¿›**:
- ç”¨æˆ·ä¸Šä¼ ç…§ç‰‡åè‡ªåŠ¨ä¸Šä¼ åˆ° MinIO
- ä¿ç•™æœ¬åœ° dataURL ç”¨äºé¢„è§ˆ
- ä¼˜å…ˆä½¿ç”¨ MinIO URLï¼Œå¤±è´¥æ—¶å›é€€åˆ° dataURL
- æ‰€æœ‰æ“ä½œï¼ˆæ‹–æ‹½æ’åºã€åˆ é™¤ç­‰ï¼‰éƒ½æ­£ç¡®å¤„ç† MinIO URL

**æµç¨‹**:
1. ç”¨æˆ·é€‰æ‹©æ–‡ä»¶ â†’ è½¬æ¢ä¸º dataURL
2. è´¨é‡æ£€æµ‹ï¼ˆæœ¬åœ°ï¼‰
3. ä¸Šä¼ åˆ° MinIO
4. è¿”å› MinIO URL ç»™çˆ¶ç»„ä»¶

---

### 4. âœ… ä¿®æ”¹ CreatePage ç»„ä»¶
**æ–‡ä»¶**: `src/views/CreatePage.tsx`

**æ”¹è¿›**:
- æ¥æ”¶ PhotoUploader è¿”å›çš„ MinIO URL
- AI ç”Ÿæˆå›¾ç‰‡åè‡ªåŠ¨ä¸Šä¼ åˆ° MinIO
- ä½¿ç”¨ MinIO URL å­˜å‚¨åˆ°æ•°æ®åº“
- å¤±è´¥æ—¶æœ‰é™çº§æ–¹æ¡ˆ

**æµç¨‹**:
1. ç”¨æˆ·ä¸Šä¼ çš„ç…§ç‰‡ï¼ˆå·²æ˜¯ MinIO URLï¼‰â†’ ä¼ ç»™ AI
2. AI ç”Ÿæˆå›¾ç‰‡ï¼ˆè¿”å› base64ï¼‰
3. ä¸Šä¼ ç”Ÿæˆçš„å›¾ç‰‡åˆ° MinIO
4. å°† MinIO URL å­˜å‚¨åˆ°æ•°æ®åº“

---

### 5. âœ… æ•°æ®åº“ Schema
**æ–‡ä»¶**: `database-schema.sql`

**ç»“è®º**: æ— éœ€ä¿®æ”¹ï¼

ç°æœ‰çš„ `jsonb` ç±»å‹å­—æ®µå¯ä»¥åŒæ—¶å­˜å‚¨ï¼š
- âœ… base64 å­—ç¬¦ä¸²ï¼ˆæ—§æ•°æ®ï¼‰
- âœ… MinIO URL å­—ç¬¦ä¸²ï¼ˆæ–°æ•°æ®ï¼‰

å…¼å®¹æ€§è‰¯å¥½ï¼Œæ”¯æŒå¹³æ»‘è¿ç§»ã€‚

---

### 6. âœ… æµ‹è¯•å·¥å…·
**æ–‡ä»¶**: `test-minio.js`

**åŠŸèƒ½**:
- éªŒè¯ MinIO è¿æ¥
- æµ‹è¯• bucket åˆ›å»ºå’Œç­–ç•¥è®¾ç½®
- æµ‹è¯•æ–‡ä»¶ä¸Šä¼ å’Œåˆ é™¤
- æµ‹è¯•æ–‡ä»¶åˆ—è¡¨

**æµ‹è¯•ç»“æœ**: âœ… å…¨éƒ¨é€šè¿‡
```
âœ… Bucket "ai-images" å·²å­˜åœ¨
âœ… æµ‹è¯•å›¾ç‰‡ä¸Šä¼ æˆåŠŸ
âœ… æ€»å…±æ‰¾åˆ° 1 ä¸ªæ–‡ä»¶
âœ… æµ‹è¯•æ–‡ä»¶å·²åˆ é™¤
âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼MinIO é…ç½®æ­£ç¡®ã€‚
```

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### 1. æ€§èƒ½æå‡
- âŒ **ä¹‹å‰**: base64 å­˜å‚¨åœ¨æ•°æ®åº“ï¼ŒæŸ¥è¯¢æ…¢ï¼Œå ç”¨ç©ºé—´å¤§
- âœ… **ç°åœ¨**: åªå­˜å‚¨ URLï¼Œæ•°æ®åº“ä½“ç§¯å‡å°‘ 90%+

### 2. å¯æ‰©å±•æ€§
- âŒ **ä¹‹å‰**: æ•°æ®åº“å®¹é‡é™åˆ¶
- âœ… **ç°åœ¨**: MinIO ç‹¬ç«‹æ‰©å±•ï¼Œæ”¯æŒ PB çº§å­˜å‚¨

### 3. åŠ è½½é€Ÿåº¦
- âŒ **ä¹‹å‰**: ä»æ•°æ®åº“è¯»å–å¤§ base64 å­—ç¬¦ä¸²
- âœ… **ç°åœ¨**: ç›´æ¥ä» MinIO CDN åŠ è½½ï¼Œæ”¯æŒç¼“å­˜

### 4. æˆæœ¬ä¼˜åŒ–
- âŒ **ä¹‹å‰**: æ•°æ®åº“å­˜å‚¨æˆæœ¬é«˜
- âœ… **ç°åœ¨**: å¯¹è±¡å­˜å‚¨æˆæœ¬ä½ 90%+

---

## ğŸ“‚ æ–‡ä»¶ç»“æ„

```
ai-wedding/
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ minio-client.ts          # MinIO å·¥å…·ç±»ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ app/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ upload-image/
â”‚           â””â”€â”€ route.ts          # ä¸Šä¼  APIï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ PhotoUploader.tsx    # ä¿®æ”¹ï¼šæ”¯æŒ MinIO
â”‚   â””â”€â”€ views/
â”‚       â””â”€â”€ CreatePage.tsx       # ä¿®æ”¹ï¼šç”Ÿæˆåä¸Šä¼  MinIO
â”œâ”€â”€ test-minio.js                 # æµ‹è¯•è„šæœ¬ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ MINIO_INTEGRATION_TEST.md     # æµ‹è¯•æŒ‡å—ï¼ˆæ–°å¢ï¼‰
â””â”€â”€ MINIO_INTEGRATION_SUMMARY.md  # æœ¬æ–‡æ¡£ï¼ˆæ–°å¢ï¼‰
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### å·²éªŒè¯çš„æµ‹è¯•é¡¹
- âœ… TypeScript ç±»å‹æ£€æŸ¥é€šè¿‡
- âœ… ç”Ÿäº§æ„å»ºæˆåŠŸ
- âœ… MinIO è¿æ¥æµ‹è¯•é€šè¿‡
- âœ… Bucket åˆ›å»ºå’Œç­–ç•¥è®¾ç½®
- âœ… æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½
- âœ… å…¬å…±è®¿é—®æƒé™

### éœ€è¦æ‰‹åŠ¨æµ‹è¯•çš„é¡¹ç›®
- [ ] ç”¨æˆ·ä¸Šä¼ ç…§ç‰‡ â†’ æŸ¥çœ‹ MinIO URL
- [ ] AI ç”Ÿæˆå›¾ç‰‡ â†’ æŸ¥çœ‹ MinIO URL
- [ ] ç»“æœé¡µé¢æ˜¾ç¤ºå›¾ç‰‡
- [ ] å›¾ç‰‡ä¸‹è½½åŠŸèƒ½
- [ ] å¤šå¼ å›¾ç‰‡æ‰¹é‡ä¸Šä¼ 

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. éªŒè¯ç¯å¢ƒ
```bash
# è¿è¡Œ MinIO æµ‹è¯•
node test-minio.js
```

### 2. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
```bash
pnpm run dev
```

### 3. æµ‹è¯•å®Œæ•´æµç¨‹
1. è®¿é—® http://localhost:3000/templates
2. é€‰æ‹©ä¸€ä¸ªæ¨¡æ¿
3. ä¸Šä¼ ç…§ç‰‡ï¼ˆè§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—ï¼‰
4. ç”Ÿæˆå›¾ç‰‡ï¼ˆè§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—ï¼‰
5. æŸ¥çœ‹ç»“æœé¡µé¢

### 4. æŸ¥çœ‹ MinIO æ§åˆ¶å°
è®¿é—®: http://123.57.16.107:9000
- ç”¨æˆ·å: `minioadmin`
- å¯†ç : `minioadmin`

æŸ¥çœ‹ `ai-images` bucket ä¸­çš„æ–‡ä»¶ï¼š
- `uploads/` - ç”¨æˆ·ä¸Šä¼ çš„ç…§ç‰‡
- `generated/` - AI ç”Ÿæˆçš„å›¾ç‰‡
- `test/` - æµ‹è¯•æ–‡ä»¶

---

## ğŸ“Š å­˜å‚¨ç»“æ„

### MinIO Bucket: `ai-images`
```
ai-images/
â”œâ”€â”€ uploads/           # ç”¨æˆ·ä¸Šä¼ çš„åŸå§‹ç…§ç‰‡
â”‚   â”œâ”€â”€ 1234567890-uuid.jpg
â”‚   â””â”€â”€ 1234567891-uuid.png
â”œâ”€â”€ generated/         # AI ç”Ÿæˆçš„å›¾ç‰‡
â”‚   â”œâ”€â”€ 1234567892-uuid.png
â”‚   â””â”€â”€ 1234567893-uuid.png
â””â”€â”€ test/             # æµ‹è¯•æ–‡ä»¶
    â””â”€â”€ test-xxx.png
```

### æ•°æ®åº“å­˜å‚¨
```json
// projects.uploaded_photos
[
  "http://123.57.16.107:9000/ai-images/uploads/xxx.jpg",
  "http://123.57.16.107:9000/ai-images/uploads/yyy.jpg"
]

// generations.preview_images
[
  "http://123.57.16.107:9000/ai-images/generated/aaa.png",
  "http://123.57.16.107:9000/ai-images/generated/bbb.png"
]
```

---

## ğŸ”§ è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹ä¸Šä¼ æ—¥å¿—
æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼Œæœç´¢ï¼š
- `ä¸Šä¼ å›¾ç‰‡ N åˆ° MinIO...`
- `âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:`
- å¦‚æœå¤±è´¥ä¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯

### 2. æ£€æŸ¥ç½‘ç»œè¯·æ±‚
åœ¨ DevTools Network é¢æ¿ä¸­ï¼š
- æŸ¥æ‰¾ `/api/upload-image` è¯·æ±‚
- æŸ¥çœ‹å“åº”ä¸­çš„ `url` å­—æ®µ
- ç¡®è®¤å›¾ç‰‡ä» MinIO åŠ è½½

### 3. éªŒè¯å›¾ç‰‡å¯è®¿é—®
ç›´æ¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ MinIO URLï¼š
```
http://123.57.16.107:9000/ai-images/uploads/xxx.png
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: å›¾ç‰‡ä¸Šä¼ å¤±è´¥
**æ£€æŸ¥é¡¹**:
1. MinIO æœåŠ¡æ˜¯å¦è¿è¡Œ: `node test-minio.js`
2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
3. æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯æ—¥å¿—

### Q2: å›¾ç‰‡æ˜¾ç¤ºä¸º base64
**åŸå› **: ä¸Šä¼ å¤±è´¥ï¼Œç³»ç»Ÿå›é€€åˆ° base64

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ `/api/upload-image` API æ˜¯å¦å¯è®¿é—®
2. æŸ¥çœ‹æ§åˆ¶å°ä¸­çš„é”™è¯¯ä¿¡æ¯
3. éªŒè¯ MinIO é…ç½®

### Q3: Bucket ä¸å­˜åœ¨
**è§£å†³æ–¹æ¡ˆ**:
```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬ï¼Œè‡ªåŠ¨åˆ›å»º bucket
node test-minio.js
```

---

## ğŸ“ ä»£ç ç¤ºä¾‹

### ä¸Šä¼  base64 å›¾ç‰‡
```typescript
import { uploadBase64Image } from '@/lib/minio-client';

const result = await uploadBase64Image(
  'data:image/png;base64,iVBORw0KG...',
  { folder: 'uploads' }
);

console.log(result.url);
// http://123.57.16.107:9000/ai-images/uploads/xxx.png
```

### ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶
```typescript
import { uploadImage } from '@/lib/minio-client';

const result = await uploadImage({
  buffer: fileBuffer,
  originalName: 'photo.jpg',
  contentType: 'image/jpeg',
  folder: 'uploads'
});
```

### åˆ é™¤å›¾ç‰‡
```typescript
import { deleteImage } from '@/lib/minio-client';

await deleteImage('uploads/xxx.png');
```

---

## ğŸ“ˆ åç»­ä¼˜åŒ–å»ºè®®

### 1. å›¾ç‰‡å‹ç¼© (ä¼˜å…ˆçº§: é«˜)
- ä¸Šä¼ å‰è‡ªåŠ¨å‹ç¼©ï¼Œå‡å°‘å­˜å‚¨æˆæœ¬
- ä½¿ç”¨ `sharp` æˆ– browser-image-compression
- ç”Ÿæˆå¤šç§å°ºå¯¸çš„ç¼©ç•¥å›¾

### 2. CDN åŠ é€Ÿ (ä¼˜å…ˆçº§: é«˜)
- åœ¨ MinIO å‰é…ç½® CDNï¼ˆCloudFlare/é˜¿é‡Œäº‘ï¼‰
- åŠ å¿«å…¨çƒè®¿é—®é€Ÿåº¦
- å‡å°‘ MinIO æœåŠ¡å™¨å‹åŠ›

### 3. è®¿é—®ç»Ÿè®¡ (ä¼˜å…ˆçº§: ä¸­)
- è®°å½•å›¾ç‰‡è®¿é—®æ¬¡æ•°
- åˆ†æçƒ­é—¨å›¾ç‰‡
- ä¼˜åŒ–å­˜å‚¨ç­–ç•¥

### 4. è‡ªåŠ¨æ¸…ç† (ä¼˜å…ˆçº§: ä¸­)
- å®šæœŸæ¸…ç†æœªä½¿ç”¨çš„å›¾ç‰‡
- è®¾ç½®è¿‡æœŸç­–ç•¥
- é‡Šæ”¾å­˜å‚¨ç©ºé—´

### 5. æ°´å°å¤„ç† (ä¼˜å…ˆçº§: ä½)
- é¢„è§ˆå›¾è‡ªåŠ¨æ·»åŠ æ°´å°
- è´­ä¹°åæä¾›æ— æ°´å°ç‰ˆæœ¬
- é˜²æ­¢å›¾ç‰‡ç›—ç”¨

---

## âœ¨ æ€»ç»“

æœ¬æ¬¡ MinIO é›†æˆå®ç°äº†ï¼š
- âœ… å®Œæ•´çš„å›¾ç‰‡ä¸Šä¼ å’Œå­˜å‚¨åŠŸèƒ½
- âœ… ä¸ç°æœ‰ç³»ç»Ÿæ— ç¼é›†æˆ
- âœ… ä¿ç•™é™çº§æ–¹æ¡ˆï¼Œç¡®ä¿å¯é æ€§
- âœ… è¯¦ç»†çš„æ–‡æ¡£å’Œæµ‹è¯•å·¥å…·
- âœ… æ€§èƒ½å’Œæˆæœ¬æ˜¾è‘—ä¼˜åŒ–

**çŠ¶æ€**: ğŸ‰ **å·²å®Œæˆï¼Œå¯æŠ•å…¥ç”Ÿäº§ä½¿ç”¨**

---

## ğŸ“ æ”¯æŒ

é‡åˆ°é—®é¢˜ï¼Ÿ
1. æŸ¥çœ‹ `MINIO_INTEGRATION_TEST.md` æµ‹è¯•æŒ‡å—
2. è¿è¡Œ `node test-minio.js` è¯Šæ–­å·¥å…·
3. æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—å’Œç½‘ç»œè¯·æ±‚
4. æŸ¥çœ‹ MinIO æ§åˆ¶å°ç¡®è®¤æ–‡ä»¶çŠ¶æ€

**ç”Ÿæˆæ—¶é—´**: 2025-01-11
**ç‰ˆæœ¬**: v1.0.0





