# MinIO é›†æˆæµ‹è¯•æŒ‡å—

## âœ… å·²å®Œæˆçš„é›†æˆå·¥ä½œ

### 1. MinIO SDK å’Œå·¥å…·ç±»
- âœ… å®‰è£…äº† `minio` åŒ…
- âœ… åˆ›å»ºäº† `lib/minio-client.ts` å·¥å…·ç±»
- âœ… æ”¯æŒçš„åŠŸèƒ½ï¼š
  - ä¸Šä¼ å›¾ç‰‡ï¼ˆæ”¯æŒ Buffer å’Œ base64/dataURLï¼‰
  - åˆ é™¤å›¾ç‰‡ï¼ˆå•ä¸ªå’Œæ‰¹é‡ï¼‰
  - ç”Ÿæˆé¢„ç­¾å URL
  - è‡ªåŠ¨åˆ›å»ºå’Œé…ç½® bucket

### 2. å›¾ç‰‡ä¸Šä¼  API
- âœ… åˆ›å»ºäº† `/api/upload-image` è·¯ç”±
- âœ… æ”¯æŒä¸¤ç§ä¸Šä¼ æ–¹å¼ï¼š
  - JSON æ ¼å¼ï¼ˆbase64/dataURLï¼‰
  - FormData æ ¼å¼ï¼ˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼‰
- âœ… è¿”å›æ ¼å¼ï¼š
  ```json
  {
    "success": true,
    "url": "http://123.57.16.107:9000/ai-images/uploads/xxx.png",
    "objectName": "uploads/xxx.png",
    "bucket": "ai-images"
  }
  ```

### 3. PhotoUploader ç»„ä»¶
- âœ… ä¿®æ”¹äº† `src/components/PhotoUploader.tsx`
- âœ… ç”¨æˆ·ä¸Šä¼ ç…§ç‰‡æ—¶ï¼š
  1. è½¬æ¢ä¸º dataURLï¼ˆç”¨äºæœ¬åœ°é¢„è§ˆï¼‰
  2. è´¨é‡æ£€æµ‹
  3. ä¸Šä¼ åˆ° MinIO
  4. è¿”å› MinIO URL ç»™çˆ¶ç»„ä»¶
- âœ… ä¼˜å…ˆä½¿ç”¨ MinIO URLï¼Œå¤±è´¥æ—¶å›é€€åˆ° dataURL

### 4. CreatePage ç»„ä»¶
- âœ… ä¿®æ”¹äº† `src/views/CreatePage.tsx`
- âœ… å›¾ç‰‡ç”Ÿæˆæµç¨‹ï¼š
  1. ç”¨æˆ·ä¸Šä¼ çš„ç…§ç‰‡å·²ç»æ˜¯ MinIO URL
  2. AI ç”Ÿæˆå›¾ç‰‡ï¼ˆè¿”å› base64ï¼‰
  3. å°†ç”Ÿæˆçš„å›¾ç‰‡ä¸Šä¼ åˆ° MinIO
  4. ä½¿ç”¨ MinIO URL å­˜å‚¨åˆ°æ•°æ®åº“

### 5. æ•°æ®åº“
- âœ… æ— éœ€ä¿®æ”¹ schema
- âœ… ç°æœ‰çš„ jsonb å­—æ®µå¯ä»¥å­˜å‚¨ URL å­—ç¬¦ä¸²

## ğŸ§ª æµ‹è¯•æµç¨‹

### ç¯å¢ƒæ£€æŸ¥

1. **ç¡®è®¤ MinIO é…ç½®**
   ```bash
   # æ£€æŸ¥ .env æ–‡ä»¶
   cat .env | grep MINIO
   ```
   åº”è¯¥çœ‹åˆ°ï¼š
   ```
   MINIO_ENDPOINT="http://123.57.16.107:9000"
   MINIO_ACCESS_KEY="minioadmin"
   MINIO_SECRET_KEY="minioadmin"
   MINIO_BUCKET_NAME="ai-images"
   MINIO_USE_SSL="false"
   ```

2. **ç¡®è®¤ MinIO æœåŠ¡å¯è®¿é—®**
   ```bash
   # æµ‹è¯•è¿æ¥
   curl http://123.57.16.107:9000/minio/health/live
   ```

### æµ‹è¯•æ­¥éª¤

#### æ­¥éª¤ 1: å¯åŠ¨å¼€å‘æœåŠ¡å™¨
```bash
pnpm run dev
```

#### æ­¥éª¤ 2: æµ‹è¯•ç…§ç‰‡ä¸Šä¼ 
1. è®¿é—® `/templates` é¡µé¢
2. é€‰æ‹©ä¸€ä¸ªæ¨¡æ¿
3. åœ¨åˆ›å»ºé¡µé¢ä¸Šä¼ ç…§ç‰‡
4. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š
   ```
   ä¸Šä¼ å›¾ç‰‡ 1 åˆ° MinIO...
   âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ: http://123.57.16.107:9000/ai-images/uploads/xxx.png
   ```

#### æ­¥éª¤ 3: æµ‹è¯•å›¾ç‰‡ç”Ÿæˆ
1. å¡«å†™é¡¹ç›®åç§°
2. ç‚¹å‡»"ç”Ÿæˆå©šçº±ç…§"
3. ç­‰å¾…ç”Ÿæˆå®Œæˆ
4. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼š
   ```
   ä¸Šä¼ ç”Ÿæˆçš„å›¾ç‰‡åˆ° MinIO...
   âœ… ç”Ÿæˆçš„å›¾ç‰‡ä¸Šä¼ æˆåŠŸ: http://123.57.16.107:9000/ai-images/generated/xxx.png
   ```

#### æ­¥éª¤ 4: éªŒè¯å›¾ç‰‡å­˜å‚¨
1. æ£€æŸ¥æ•°æ®åº“ä¸­çš„æ•°æ®ï¼š
   - `projects.uploaded_photos` åº”è¯¥åŒ…å« MinIO URL
   - `generations.preview_images` åº”è¯¥åŒ…å« MinIO URL

2. ç›´æ¥è®¿é—® MinIO URL éªŒè¯å›¾ç‰‡å¯è®¿é—®ï¼š
   ```
   http://123.57.16.107:9000/ai-images/uploads/xxx.png
   ```

#### æ­¥éª¤ 5: æµ‹è¯•å›¾ç‰‡æ˜¾ç¤º
1. åœ¨ç»“æœé¡µé¢æŸ¥çœ‹ç”Ÿæˆçš„å›¾ç‰‡
2. å›¾ç‰‡åº”è¯¥ä» MinIO åŠ è½½
3. æ£€æŸ¥ç½‘ç»œé¢æ¿ï¼Œç¡®è®¤è¯·æ±‚çš„æ˜¯ MinIO åœ°å€

## ğŸ”§ è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹ä¸Šä¼ æ—¥å¿—
æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ŒæŸ¥çœ‹ï¼š
- `ä¸Šä¼ å›¾ç‰‡ N åˆ° MinIO...`
- `âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ: ...`
- å¦‚æœå¤±è´¥ä¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯

### 2. æ£€æŸ¥ MinIO å­˜å‚¨
è®¿é—® MinIO æ§åˆ¶å°ï¼š
```
http://123.57.16.107:9000
ç”¨æˆ·å: minioadmin
å¯†ç : minioadmin
```

æŸ¥çœ‹ `ai-images` bucket ä¸­çš„æ–‡ä»¶ï¼š
- `uploads/` æ–‡ä»¶å¤¹ï¼šç”¨æˆ·ä¸Šä¼ çš„ç…§ç‰‡
- `generated/` æ–‡ä»¶å¤¹ï¼šAI ç”Ÿæˆçš„å›¾ç‰‡

### 3. æµ‹è¯• API ç«¯ç‚¹
ä½¿ç”¨ curl æµ‹è¯•ä¸Šä¼  APIï¼š
```bash
# å‡†å¤‡ä¸€ä¸ª base64 å›¾ç‰‡
cat > test-upload.json << 'EOF'
{
  "image": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==",
  "folder": "test"
}
EOF

# è°ƒç”¨ API
curl -X POST http://localhost:3000/api/upload-image \
  -H "Content-Type: application/json" \
  -d @test-upload.json
```

é¢„æœŸè¿”å›ï¼š
```json
{
  "success": true,
  "url": "http://123.57.16.107:9000/ai-images/test/xxx.png",
  "objectName": "test/xxx.png",
  "bucket": "ai-images"
}
```

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜ 1: è¿æ¥ MinIO å¤±è´¥
**é”™è¯¯**: `ECONNREFUSED` æˆ– `Network error`

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ MinIO æœåŠ¡æ˜¯å¦è¿è¡Œ
2. æ£€æŸ¥ MINIO_ENDPOINT æ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

### é—®é¢˜ 2: ä¸Šä¼ æˆåŠŸä½†å›¾ç‰‡æ— æ³•è®¿é—®
**é”™è¯¯**: 403 Forbidden

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ bucket ç­–ç•¥æ˜¯å¦å…è®¸å…¬å…±è¯»å–
2. MinIO å·¥å…·ç±»ä¼šè‡ªåŠ¨è®¾ç½®ç­–ç•¥ï¼Œç¡®ä¿ `ensureBucketExists()` è¢«è°ƒç”¨

### é—®é¢˜ 3: å›¾ç‰‡æ˜¾ç¤ºä¸º base64 è€Œä¸æ˜¯ MinIO URL
**åŸå› **: ä¸Šä¼ å¤±è´¥æ—¶ä¼šå›é€€åˆ° base64

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥æ§åˆ¶å°é”™è¯¯æ—¥å¿—
2. ç¡®è®¤ API ç«¯ç‚¹å¯è®¿é—®
3. æ£€æŸ¥ç½‘ç»œè¿æ¥

## ğŸ“Š æ€§èƒ½ä¼˜åŠ¿

ä½¿ç”¨ MinIO åçš„æ”¹è¿›ï¼š

1. **å‡å°‘æ•°æ®åº“è´Ÿè½½**
   - ä¹‹å‰ï¼šå¤§é‡ base64 æ•°æ®å­˜å‚¨åœ¨æ•°æ®åº“ä¸­
   - ç°åœ¨ï¼šåªå­˜å‚¨å°çš„ URL å­—ç¬¦ä¸²

2. **åŠ å¿«é¡µé¢åŠ è½½**
   - ä¹‹å‰ï¼šä»æ•°æ®åº“è¯»å–å¤§ base64 å­—ç¬¦ä¸²
   - ç°åœ¨ï¼šç›´æ¥ä» MinIO CDN åŠ è½½å›¾ç‰‡

3. **æ›´å¥½çš„æ‰©å±•æ€§**
   - MinIO å¯ä»¥ç‹¬ç«‹æ‰©å±•
   - æ”¯æŒ CDN åŠ é€Ÿ
   - æ”¯æŒå›¾ç‰‡å¤„ç†ç®¡é“

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœéœ€è¦å›æ»šåˆ° base64 æ–¹å¼ï¼š

1. **PhotoUploader.tsx**
   - ä¿®æ”¹ `onChange` å›è°ƒï¼Œä½¿ç”¨ `p.dataUrl` è€Œä¸æ˜¯ `p.minioUrl || p.dataUrl`

2. **CreatePage.tsx**
   - ç§»é™¤ä¸Šä¼ åˆ° MinIO çš„ä»£ç 
   - ç›´æ¥ä½¿ç”¨ `result.imageData.dataUrl`

3. **æ•°æ®åº“**
   - æ— éœ€ä¿®æ”¹ï¼Œä»ç„¶å…¼å®¹ base64 å­—ç¬¦ä¸²

## âœ¨ åç»­ä¼˜åŒ–å»ºè®®

1. **æ·»åŠ å›¾ç‰‡å‹ç¼©**
   - ä¸Šä¼ å‰å‹ç¼©å›¾ç‰‡ï¼Œå‡å°‘å­˜å‚¨ç©ºé—´
   - ä½¿ç”¨ `sharp` æˆ– `jimp` åº“

2. **æ·»åŠ  CDN**
   - åœ¨ MinIO å‰é¢æ·»åŠ  CDNï¼ˆå¦‚ CloudFlareï¼‰
   - åŠ å¿«å…¨çƒè®¿é—®é€Ÿåº¦

3. **æ·»åŠ å›¾ç‰‡å¤„ç†**
   - ç¼©ç•¥å›¾ç”Ÿæˆ
   - æ°´å°æ·»åŠ 
   - æ ¼å¼è½¬æ¢

4. **æ·»åŠ æ¸…ç†ä»»åŠ¡**
   - å®šæœŸæ¸…ç†æœªä½¿ç”¨çš„å›¾ç‰‡
   - è®¾ç½®è¿‡æœŸç­–ç•¥

5. **æ·»åŠ è®¿é—®ç»Ÿè®¡**
   - è®°å½•å›¾ç‰‡è®¿é—®æ¬¡æ•°
   - åˆ†æçƒ­é—¨å›¾ç‰‡





