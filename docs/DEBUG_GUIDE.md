# å›¾ç‰‡ç”Ÿæˆæ¥å£è°ƒè¯•æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—å¸®åŠ©ä½ å¿«é€Ÿæ’æŸ¥ `/api/generate-image` å’Œ `/api/generate-stream` æ¥å£çš„é—®é¢˜ã€‚

## ğŸ” æŸ¥çœ‹æ—¥å¿—

### 1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
cd /Users/zhangyanhua/Desktop/AI/ai-wedding
pnpm run dev
```

### 2. æ—¥å¿—ä½ç½®

æ‰€æœ‰æ—¥å¿—ä¼šè¾“å‡ºåˆ°ç»ˆç«¯æ§åˆ¶å°ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½æœ‰å”¯ä¸€çš„ `requestId`ï¼š

```
[req_1234567890_abc123] ========== å¼€å§‹å¤„ç†å›¾ç‰‡ç”Ÿæˆè¯·æ±‚ ==========
[req_1234567890_abc123] ç¯å¢ƒå˜é‡æ£€æŸ¥: { ... }
[req_1234567890_abc123] âœ… ç”¨æˆ·è®¤è¯æˆåŠŸ: user-id-xxx
...
```

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: ç¯å¢ƒå˜é‡æœªé…ç½®

**ç—‡çŠ¶ï¼š**
```
âŒ IMAGE_API_KEY æœªé…ç½®
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥ `.env` æ–‡ä»¶æ˜¯å¦å­˜åœ¨
2. ç¡®è®¤ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®ï¼š

```env
IMAGE_API_MODE=chat
IMAGE_API_BASE_URL=https://api.aioec.tech
IMAGE_API_KEY=sk-13WThvEQGdYxRfwnnafAqDRgMtqKbBUH28RhFFITW3s7D6xw
IMAGE_CHAT_MODEL=gemini-2.5-flash-image
```

3. é‡å¯å¼€å‘æœåŠ¡å™¨ï¼ˆç¯å¢ƒå˜é‡æ›´æ”¹åéœ€è¦é‡å¯ï¼‰

### é—®é¢˜ 2: ç”¨æˆ·è®¤è¯å¤±è´¥

**ç—‡çŠ¶ï¼š**
```
âŒ ç”¨æˆ·è®¤è¯å¤±è´¥: {...}
```

**åŸå› ï¼š**
- æœªç™»å½•
- Session è¿‡æœŸ
- Token æ— æ•ˆ

**è§£å†³æ–¹æ¡ˆï¼š**
1. åœ¨æµè§ˆå™¨ä¸­é‡æ–°ç™»å½•
2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰ Supabase ç›¸å…³é”™è¯¯
3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’Œ Cookiesï¼Œé‡æ–°ç™»å½•

### é—®é¢˜ 3: å‚æ•°éªŒè¯å¤±è´¥

**ç—‡çŠ¶ï¼š**
```
âŒ å‚æ•°éªŒè¯å¤±è´¥: {...}
```

**åŸå› ï¼š**
- ç¼ºå°‘å¿…å¡«å‚æ•°
- å‚æ•°ç±»å‹ä¸æ­£ç¡®
- å›¾ç‰‡æ ¼å¼ä¸æ­£ç¡®

**è§£å†³æ–¹æ¡ˆï¼š**

æŸ¥çœ‹æ—¥å¿—ä¸­çš„ `è¯·æ±‚ Body`ï¼Œç¡®ä¿åŒ…å«ï¼š

```json
{
  "prompt": "ç”Ÿæˆä¸€å¼ å©šçº±ç…§",
  "image_inputs": ["data:image/jpeg;base64,..."],
  "n": 4,
  "model": "gemini-2.5-flash-image"
}
```

**æ³¨æ„ï¼š**
- `prompt` å¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²
- `image_inputs` å¦‚æœæä¾›ï¼Œå¿…é¡»æ˜¯ `data:image/...;base64,...` æ ¼å¼çš„æ•°ç»„
- `n` æ˜¯æ•°å­—ï¼Œè¡¨ç¤ºç”Ÿæˆæ•°é‡

### é—®é¢˜ 4: ä¸Šæ¸¸ API è¿”å›é”™è¯¯

**ç—‡çŠ¶ï¼š**
```
âŒ ä¸Šæ¸¸ API è¿”å›é”™è¯¯: {
  status: 400,
  error: "Invalid request"
}
```

**æ’æŸ¥æ­¥éª¤ï¼š**

1. **æ£€æŸ¥ API Key æ˜¯å¦æœ‰æ•ˆ**
   ```bash
   # ä½¿ç”¨ curl ç›´æ¥æµ‹è¯•
   curl -X POST https://api.aioec.tech/v1/chat/completions \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer sk-13WThvEQGdYxRfwnnafAqDRgMtqKbBUH28RhFFITW3s7D6xw" \
     -d '{
       "model": "gemini-2.5-flash-image",
       "messages": [{"role": "user", "content": "test"}]
     }'
   ```

2. **æŸ¥çœ‹å®Œæ•´çš„è¯·æ±‚æ—¥å¿—**
   ```
   [req_xxx] ğŸ“¤ å‘é€è¯·æ±‚åˆ°ä¸Šæ¸¸ API: {
     endpoint: "https://api.aioec.tech/v1/chat/completions",
     model: "gemini-2.5-flash-image",
     ...
   }
   ```

3. **å¯¹æ¯” demo çš„è¯·æ±‚æ ¼å¼**
   - æ‰“å¼€ `example/image-edit-demo.html`
   - æŸ¥çœ‹ç¬¬ 538-563 è¡Œçš„è¯·æ±‚æ ¼å¼
   - ç¡®ä¿æˆ‘ä»¬çš„è¯·æ±‚æ ¼å¼ä¸ demo å®Œå…¨ä¸€è‡´

### é—®é¢˜ 5: æ— æ³•ä»å“åº”ä¸­æå–å›¾ç‰‡

**ç—‡çŠ¶ï¼š**
```
âŒ æ— æ³•ä»å“åº”ä¸­æå–å›¾ç‰‡æ•°æ®
å®Œæ•´å†…å®¹: ...
```

**åŸå› ï¼š**
- ä¸Šæ¸¸ API è¿”å›çš„å†…å®¹æ ¼å¼ä¸ç¬¦åˆé¢„æœŸ
- æ²¡æœ‰è¿”å› Markdown æ ¼å¼çš„å›¾ç‰‡

**æ’æŸ¥æ­¥éª¤ï¼š**

1. **æŸ¥çœ‹å®Œæ•´çš„å“åº”å†…å®¹**
   æ—¥å¿—ä¼šæ‰“å°å‰ 500 å­—ç¬¦ï¼š
   ```
   [req_xxx] ğŸ“„ è¿”å›å†…å®¹é¢„è§ˆ: ...
   ```

2. **æ£€æŸ¥æ˜¯å¦æ˜¯æ¨¡å‹é—®é¢˜**
   - ç¡®è®¤ä½¿ç”¨çš„æ¨¡å‹æ˜¯ `gemini-2.5-flash-image`
   - æŸäº›æ¨¡å‹å¯èƒ½ä¸æ”¯æŒå›¾ç‰‡ç”Ÿæˆ

3. **æ‰‹åŠ¨æµ‹è¯• demo**
   - æ‰“å¼€ `example/image-edit-demo.html`
   - ä½¿ç”¨ç›¸åŒçš„ prompt æµ‹è¯•
   - å¯¹æ¯”è¿”å›ç»“æœ

### é—®é¢˜ 6: é€Ÿç‡é™åˆ¶

**ç—‡çŠ¶ï¼š**
```
âš ï¸ é€Ÿç‡é™åˆ¶: ç”¨æˆ· xxx è¶…è¿‡é™åˆ¶
```

**åŸå› ï¼š**
- æ¯ç”¨æˆ·æ¯åˆ†é’Ÿæœ€å¤š 5 æ¬¡è¯·æ±‚

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç­‰å¾… 1 åˆ†é’Ÿåé‡è¯•
2. å¦‚éœ€è°ƒæ•´é™åˆ¶ï¼Œä¿®æ”¹ `route.ts` ä¸­çš„ï¼š
   ```typescript
   const RL_WINDOW_MS = 60 * 1000; // 1åˆ†é’Ÿ
   const RL_LIMIT = 5; // æ¯åˆ†é’Ÿ 5 æ¬¡
   ```

## ğŸ“Š å®Œæ•´çš„æ—¥å¿—ç¤ºä¾‹

### æˆåŠŸçš„è¯·æ±‚æ—¥å¿—

```
[req_1234567890_abc123] ========== å¼€å§‹å¤„ç†å›¾ç‰‡ç”Ÿæˆè¯·æ±‚ ==========
[req_1234567890_abc123] ç¯å¢ƒå˜é‡æ£€æŸ¥: {
  IMAGE_API_MODE: 'chat',
  IMAGE_API_BASE_URL: 'https://api.aioec.tech',
  IMAGE_API_KEY: 'sk-13WThv...',
  IMAGE_CHAT_MODEL: 'gemini-2.5-flash-image',
  SUPABASE_URL: 'https://tscqkkkbjkwshiynwpam.supabase.co'
}
[req_1234567890_abc123] è®¤è¯ Header: Bearer eyJhbGciOiJIUzI1N...
[req_1234567890_abc123] âœ… ç”¨æˆ·è®¤è¯æˆåŠŸ: 12345678-1234-1234-1234-123456789abc
[req_1234567890_abc123] é€Ÿç‡é™åˆ¶æ£€æŸ¥é€šè¿‡: 1/5
[req_1234567890_abc123] è¯·æ±‚ Body: {
  "prompt": "ç”Ÿæˆä¸€å¼ å©šçº±ç…§",
  "image_inputs": ["data:image/jpeg;base64,..."],
  "n": 4
}
[req_1234567890_abc123] âœ… å‚æ•°éªŒè¯é€šè¿‡: {
  prompt: 'ç”Ÿæˆä¸€å¼ å©šçº±ç…§',
  n: 4,
  model: 'gemini-2.5-flash-image',
  image_inputs_count: 1
}
[req_1234567890_abc123] ğŸ“ ä½¿ç”¨ Chat æ¨¡å¼ç”Ÿæˆå›¾ç‰‡
[req_1234567890_abc123] API ç«¯ç‚¹: https://api.aioec.tech/v1/chat/completions
[req_1234567890_abc123] å›¾ç‰‡è¾“å…¥: 1 å¼ 
[req_1234567890_abc123]   - å›¾ç‰‡: data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAA...
[req_1234567890_abc123] ğŸ“¤ å‘é€è¯·æ±‚åˆ°ä¸Šæ¸¸ API: {
  endpoint: 'https://api.aioec.tech/v1/chat/completions',
  model: 'gemini-2.5-flash-image',
  temperature: 1,
  top_p: 1,
  messages_count: 1,
  content_items: 2
}
[req_1234567890_abc123] ğŸ“¥ æ”¶åˆ°å“åº”: 200 OK (è€—æ—¶: 45231ms)
[req_1234567890_abc123] ğŸ“¦ ä¸Šæ¸¸ API å“åº”æ•°æ®: {
  choices_count: 1,
  has_content: true,
  content_length: 125847
}
[req_1234567890_abc123] ğŸ“„ è¿”å›å†…å®¹é¢„è§ˆ: ![image](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAB...
[req_1234567890_abc123] âœ… æˆåŠŸæå–å›¾ç‰‡æ•°æ®: {
  mimeType: 'png',
  base64_length: 125680,
  estimated_size_kb: 94
}
[req_1234567890_abc123] âœ… å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼Œè¿”å› 4 å¼ å›¾ç‰‡
[req_1234567890_abc123] ========== è¯·æ±‚å¤„ç†å®Œæˆ ==========
```

## ğŸ”§ è°ƒè¯•æŠ€å·§

### 1. å¢åŠ æ—¥å¿—è¯¦ç»†ç¨‹åº¦

å¦‚æœéœ€è¦æŸ¥çœ‹æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼Œå¯ä»¥ä¸´æ—¶æ·»åŠ æ—¥å¿—ï¼š

```typescript
// åœ¨ route.ts ä¸­æ·»åŠ 
console.log(`[${requestId}] ğŸ” è¯¦ç»†è°ƒè¯•:`, {
  // æ·»åŠ ä½ æƒ³æŸ¥çœ‹çš„å˜é‡
});
```

### 2. ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·

1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. åˆ‡æ¢åˆ° Network æ ‡ç­¾
3. ç­›é€‰ XHR/Fetch è¯·æ±‚
4. æŸ¥æ‰¾ `/api/generate-image` æˆ– `/api/generate-stream`
5. æŸ¥çœ‹è¯·æ±‚å’Œå“åº”è¯¦æƒ…

### 3. ä½¿ç”¨ curl ç›´æ¥æµ‹è¯•

```bash
# è·å– access tokenï¼ˆä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­å¤åˆ¶ï¼‰
ACCESS_TOKEN="eyJhbGci..."

# æµ‹è¯• /api/generate-image
curl -X POST http://localhost:3000/api/generate-image \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -d '{
    "prompt": "ç”Ÿæˆä¸€å¼ å©šçº±ç…§",
    "image_inputs": [],
    "n": 1
  }'
```

### 4. å¯¹æ¯” demo å®ç°

å½“é‡åˆ°é—®é¢˜æ—¶ï¼Œå»ºè®®ï¼š

1. æ‰“å¼€ `example/image-edit-demo.html`
2. åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ
3. æ‰“å¼€å¼€å‘è€…å·¥å…·æŸ¥çœ‹ç½‘ç»œè¯·æ±‚
4. å¯¹æ¯”è¯·æ±‚æ ¼å¼å’Œå“åº”æ ¼å¼
5. ç¡®ä¿æˆ‘ä»¬çš„å®ç°ä¸ demo å®Œå…¨ä¸€è‡´

## ğŸ“ å¯»æ±‚å¸®åŠ©

å¦‚æœä»¥ä¸Šæ­¥éª¤éƒ½æ— æ³•è§£å†³é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **å®Œæ•´çš„é”™è¯¯æ—¥å¿—**ï¼ˆåŒ…æ‹¬ `[req_xxx]` å‰ç¼€çš„æ‰€æœ‰è¡Œï¼‰
2. **ç¯å¢ƒä¿¡æ¯**
   ```bash
   node --version
   pnpm --version
   ```
3. **è¯·æ±‚å‚æ•°**ï¼ˆè„±æ•åï¼‰
4. **æˆªå›¾**ï¼ˆå¦‚æœæœ‰ï¼‰

## ğŸ“š å‚è€ƒèµ„æ–™

- **åŸå§‹ demo**: `example/image-edit-demo.html`
- **API æ–‡æ¡£**: `docs/STREAMING_IMAGE_API.md`
- **æ›´æ–°æ—¥å¿—**: `CHANGELOG_STREAMING.md`
- **ä¸Šæ¸¸ API**: https://api.aioec.tech/v1/docs

## âœ… å¿«é€Ÿæ£€æŸ¥æ¸…å•

- [ ] `.env` æ–‡ä»¶é…ç½®æ­£ç¡®
- [ ] å¼€å‘æœåŠ¡å™¨å·²é‡å¯
- [ ] ç”¨æˆ·å·²ç™»å½•
- [ ] è¯·æ±‚å‚æ•°æ ¼å¼æ­£ç¡®
- [ ] API Key æœ‰æ•ˆ
- [ ] æŸ¥çœ‹äº†å®Œæ•´çš„æ—¥å¿—
- [ ] å¯¹æ¯”äº† demo å®ç°
- [ ] æ£€æŸ¥äº†æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯

---

**æç¤º**: å»ºè®®å…ˆåœ¨ demo (`example/image-edit-demo.html`) ä¸­æµ‹è¯•ï¼Œç¡®è®¤ API å’Œå‚æ•°éƒ½æ˜¯æ­£ç¡®çš„ï¼Œå†æ’æŸ¥æˆ‘ä»¬çš„å®ç°ã€‚





