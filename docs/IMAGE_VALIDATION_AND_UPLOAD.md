# å›¾ç‰‡éªŒè¯å’Œä¸Šä¼ ä¼˜åŒ–

## ğŸ“‹ ä¼˜åŒ–æ¦‚è¿°

ä¸º"ç”Ÿæˆå•å¼ "åŠŸèƒ½æ·»åŠ äº†ä¸¤ä¸ªé‡è¦ä¼˜åŒ–ï¼š
1. **ä¸Šä¼ å›¾ç‰‡å‰éªŒè¯** - ä½¿ç”¨ `/api/identify-image` æ¥å£éªŒè¯å›¾ç‰‡æ˜¯å¦åŒ…å«äººç‰©
2. **è‡ªåŠ¨ä¸Šä¼ åˆ° MinIO** - ä¸Šä¼ çš„åŸå›¾å’Œç”Ÿæˆçš„ç»“æœå›¾éƒ½è‡ªåŠ¨ä¿å­˜åˆ° MinIO

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### 1. å›¾ç‰‡éªŒè¯åŠŸèƒ½

#### éªŒè¯æµç¨‹
```
ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡
    â†“
æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
    â†“
å·²ç™»å½• â†’ è°ƒç”¨ /api/identify-image éªŒè¯
    â”œâ”€ åŒ…å«äººç‰© â†’ âœ… éªŒè¯é€šè¿‡ï¼Œç»§ç»­
    â””â”€ ä¸åŒ…å«äººç‰© â†’ âŒ æ˜¾ç¤ºé”™è¯¯ï¼Œæ‹’ç»ä¸Šä¼ 
    â†“
æœªç™»å½• â†’ è·³è¿‡éªŒè¯ï¼Œç›´æ¥ä½¿ç”¨
```

#### æŠ€æœ¯å®ç°
```typescript
// ä½¿ç”¨ useImageIdentification Hook
const { identifyImages, isIdentifying } = useImageIdentification();

// éªŒè¯å›¾ç‰‡
const identifyResult = await identifyImages([dataUrl]);

if (!identifyResult.allValid) {
  // å›¾ç‰‡ä¸åŒ…å«äººç‰©
  const invalidResult = identifyResult.results.find(r => !r.hasPerson);
  setError(
    `æ£€æµ‹åˆ°å›¾ç‰‡æœªåŒ…å«äººç‰©ï¼š${invalidResult?.description}ã€‚
    è¯·é‡æ–°é€‰æ‹©åŒ…å«äººç‰©çš„ç…§ç‰‡ã€‚`
  );
  return;
}
```

#### ç”¨æˆ·ä½“éªŒ
- âœ… **éªŒè¯ä¸­**: æ˜¾ç¤ºåŠ è½½åŠ¨ç”»å’Œ"æ­£åœ¨éªŒè¯å›¾ç‰‡..."æç¤º
- âœ… **éªŒè¯é€šè¿‡**: æ˜¾ç¤ºç»¿è‰²æç¤ºæ¡†"å›¾ç‰‡éªŒè¯é€šè¿‡"
- âŒ **éªŒè¯å¤±è´¥**: æ˜¾ç¤ºçº¢è‰²é”™è¯¯æç¤ºï¼Œè¯´æ˜åŸå› 
- ğŸ”“ **æœªç™»å½•ç”¨æˆ·**: è·³è¿‡éªŒè¯ï¼Œç›´æ¥ä½¿ç”¨ï¼ˆä½“éªŒæ¨¡å¼ï¼‰

### 2. MinIO è‡ªåŠ¨ä¸Šä¼ 

#### ä¸Šä¼ æ—¶æœº
1. **åŸå›¾ä¸Šä¼ **: ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡å¹¶éªŒè¯é€šè¿‡å
2. **ç»“æœä¸Šä¼ **: AI ç”Ÿæˆå›¾ç‰‡å®Œæˆå

#### æ–‡ä»¶å¤¹ç»“æ„
```
MinIO Bucket: ai-images
â”œâ”€â”€ generate-single/
â”‚   â”œâ”€â”€ uploads/          # ç”¨æˆ·ä¸Šä¼ çš„åŸå›¾
â”‚   â”‚   â””â”€â”€ {timestamp}-{uuid}.{ext}
â”‚   â””â”€â”€ results/          # AI ç”Ÿæˆçš„ç»“æœå›¾
â”‚       â””â”€â”€ {timestamp}-{uuid}.{ext}
```

#### æŠ€æœ¯å®ç°

##### ä¸Šä¼ åŸå›¾
```typescript
const uploadImageToMinio = async (dataUrl: string) => {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session?.access_token) {
    console.warn('æœªç™»å½•ï¼Œè·³è¿‡ä¸Šä¼ åˆ° MinIO');
    return;
  }

  const response = await fetch('/api/upload-image', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${session.access_token}`,
    },
    body: JSON.stringify({
      image: dataUrl,
      folder: 'generate-single/uploads',
    }),
  });

  if (response.ok) {
    const result = await response.json();
    setUploadedImageUrl(result.presignedUrl || result.url);
  }
};
```

##### ä¸Šä¼ ç”Ÿæˆç»“æœ
```typescript
const uploadGeneratedImageToMinio = async (imageDataUrl: string) => {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session?.access_token) {
    console.warn('æœªç™»å½•ï¼Œè·³è¿‡ä¸Šä¼ ç”Ÿæˆå›¾ç‰‡åˆ° MinIO');
    return;
  }

  const response = await fetch('/api/upload-image', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${session.access_token}`,
    },
    body: JSON.stringify({
      image: imageDataUrl,
      folder: 'generate-single/results',
    }),
  });

  if (response.ok) {
    const result = await response.json();
    console.log('ç”Ÿæˆçš„å›¾ç‰‡å·²ä¸Šä¼ åˆ° MinIO:', result.url);
    setSuccess('å›¾ç‰‡ç”Ÿæˆå®Œæˆå¹¶å·²ä¿å­˜ï¼');
  }
};
```

## ğŸ”§ ä½¿ç”¨çš„æ¥å£

### 1. /api/identify-image

#### åŠŸèƒ½
è¯†åˆ«å›¾ç‰‡ä¸­æ˜¯å¦åŒ…å«äººç‰©

#### è¯·æ±‚æ ¼å¼
```typescript
POST /api/identify-image
Headers:
  Authorization: Bearer {token}
  Content-Type: application/json
Body:
  {
    "images": ["data:image/jpeg;base64,..."]
  }
```

#### å“åº”æ ¼å¼
```typescript
{
  "success": true,
  "total": 1,
  "validCount": 1,
  "invalidCount": 0,
  "results": [
    {
      "index": 0,
      "success": true,
      "hasPerson": true,
      "confidence": 0.9,
      "description": "YES - å›¾ç‰‡ä¸­åŒ…å«ä¸€ä½å¥³æ€§"
    }
  ],
  "allValid": true
}
```

### 2. /api/upload-image

#### åŠŸèƒ½
ä¸Šä¼ å›¾ç‰‡åˆ° MinIO å¯¹è±¡å­˜å‚¨

#### è¯·æ±‚æ ¼å¼
```typescript
POST /api/upload-image
Headers:
  Authorization: Bearer {token}
  Content-Type: application/json
Body:
  {
    "image": "data:image/jpeg;base64,...",
    "folder": "generate-single/uploads"
  }
```

#### å“åº”æ ¼å¼
```typescript
{
  "success": true,
  "url": "https://minio.example.com/...",
  "publicUrl": "https://minio.example.com/...",
  "presignedUrl": "https://minio.example.com/...?X-Amz-...",
  "objectName": "generate-single/uploads/1234567890-uuid.jpg",
  "bucket": "ai-images"
}
```

## ğŸ“Š å®Œæ•´æµç¨‹

### ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡
```
1. ç”¨æˆ·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶
   â†“
2. éªŒè¯æ–‡ä»¶ç±»å‹å’Œå¤§å°
   â†“
3. è¯»å–ä¸º DataURL
   â†“
4. æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
   â”œâ”€ å·²ç™»å½•:
   â”‚   â”œâ”€ è°ƒç”¨ /api/identify-image éªŒè¯
   â”‚   â”œâ”€ éªŒè¯é€šè¿‡ â†’ è®¾ç½®å›¾ç‰‡
   â”‚   â”œâ”€ è°ƒç”¨ /api/upload-image ä¸Šä¼ åˆ° MinIO
   â”‚   â””â”€ æ˜¾ç¤º"å›¾ç‰‡éªŒè¯é€šè¿‡"
   â””â”€ æœªç™»å½•:
       â””â”€ ç›´æ¥è®¾ç½®å›¾ç‰‡ï¼ˆè·³è¿‡éªŒè¯å’Œä¸Šä¼ ï¼‰
```

### AI ç”Ÿæˆå›¾ç‰‡
```
1. ç”¨æˆ·ç‚¹å‡»"å¼€å§‹AIç”Ÿæˆ"
   â†“
2. è°ƒç”¨ /api/generate-stream ç”Ÿæˆå›¾ç‰‡
   â†“
3. æµå¼æ¥æ”¶å“åº”
   â†“
4. è§£æ base64 å›¾ç‰‡æ•°æ®
   â†“
5. è®¾ç½®ç”Ÿæˆçš„å›¾ç‰‡
   â†“
6. è°ƒç”¨ /api/upload-image ä¸Šä¼ åˆ° MinIO
   â†“
7. æ˜¾ç¤º"å›¾ç‰‡ç”Ÿæˆå®Œæˆå¹¶å·²ä¿å­˜ï¼"
```

## ğŸ¨ UI çŠ¶æ€

### ä¸Šä¼ åŒºåŸŸçŠ¶æ€

#### 1. æœªä¸Šä¼ 
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ“·                        â”‚
â”‚   ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡        â”‚
â”‚   æ”¯æŒ JPG, PNG, WebP       â”‚
â”‚   ä¸Šä¼ åå°†è‡ªåŠ¨éªŒè¯...       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. éªŒè¯ä¸­
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   âŸ³                         â”‚
â”‚   æ­£åœ¨éªŒè¯å›¾ç‰‡...           â”‚
â”‚   æ£€æµ‹å›¾ç‰‡æ˜¯å¦åŒ…å«äººç‰©      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3. éªŒè¯é€šè¿‡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   [å›¾ç‰‡é¢„è§ˆ]                â”‚
â”‚   æ–‡ä»¶å: photo.jpg         â”‚
â”‚   å¤§å°: 2.5 MB              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… å›¾ç‰‡éªŒè¯é€šè¿‡             â”‚
â”‚    å·²æ£€æµ‹åˆ°äººç‰©ï¼Œå¯ä»¥ç»§ç»­   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4. éªŒè¯å¤±è´¥
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ æ£€æµ‹åˆ°å›¾ç‰‡æœªåŒ…å«äººç‰©     â”‚
â”‚    NO - å›¾ç‰‡ä¸­æ²¡æœ‰äººç‰©      â”‚
â”‚    è¯·é‡æ–°é€‰æ‹©åŒ…å«äººç‰©çš„ç…§ç‰‡ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”’ å®‰å…¨æ€§

### è®¤è¯ä¿æŠ¤
- âœ… æ‰€æœ‰ API è°ƒç”¨éƒ½éœ€è¦ Supabase è®¤è¯ token
- âœ… æœªç™»å½•ç”¨æˆ·æ— æ³•è°ƒç”¨éªŒè¯å’Œä¸Šä¼ æ¥å£
- âœ… æœåŠ¡ç«¯éªŒè¯ç”¨æˆ·èº«ä»½

### æ•°æ®éš”ç¦»
- âœ… æ¯ä¸ªç”¨æˆ·çš„å›¾ç‰‡å­˜å‚¨åœ¨ç‹¬ç«‹çš„æ–‡ä»¶å¤¹
- âœ… ä½¿ç”¨é¢„ç­¾å URL ä¿æŠ¤å›¾ç‰‡è®¿é—®
- âœ… å›¾ç‰‡ URL æœ‰æ—¶æ•ˆæ€§

### é”™è¯¯å¤„ç†
- âœ… ç½‘ç»œé”™è¯¯ä¸å½±å“ä¸»æµç¨‹
- âœ… ä¸Šä¼ å¤±è´¥æ—¶ä½¿ç”¨ DataURL å›é€€
- âœ… å‹å¥½çš„é”™è¯¯æç¤º

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### å¼‚æ­¥å¤„ç†
- âœ… å›¾ç‰‡éªŒè¯å’Œä¸Šä¼ ä¸é˜»å¡ UI
- âœ… ä½¿ç”¨åŠ è½½çŠ¶æ€æç¤ºç”¨æˆ·
- âœ… å¤±è´¥æ—¶ä¸å½±å“åç»­æ“ä½œ

### å›é€€æœºåˆ¶
- âœ… MinIO ä¸Šä¼ å¤±è´¥æ—¶ä½¿ç”¨ DataURL
- âœ… æœªç™»å½•ç”¨æˆ·è·³è¿‡éªŒè¯å’Œä¸Šä¼ 
- âœ… ä¿è¯åŠŸèƒ½å¯ç”¨æ€§

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åŠŸèƒ½æµ‹è¯•
- âœ… ä¸Šä¼ åŒ…å«äººç‰©çš„å›¾ç‰‡ â†’ éªŒè¯é€šè¿‡
- âœ… ä¸Šä¼ ä¸åŒ…å«äººç‰©çš„å›¾ç‰‡ â†’ éªŒè¯å¤±è´¥
- âœ… æœªç™»å½•ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡ â†’ è·³è¿‡éªŒè¯
- âœ… ç”Ÿæˆå›¾ç‰‡åè‡ªåŠ¨ä¸Šä¼ åˆ° MinIO
- âœ… MinIO ä¸Šä¼ å¤±è´¥æ—¶å›é€€åˆ° DataURL

### è¾¹ç•Œæµ‹è¯•
- âœ… ç½‘ç»œæ–­å¼€æ—¶çš„é”™è¯¯å¤„ç†
- âœ… API è¶…æ—¶çš„å¤„ç†
- âœ… æ— æ•ˆçš„å›¾ç‰‡æ ¼å¼
- âœ… è¶…å¤§å›¾ç‰‡æ–‡ä»¶

### ç”¨æˆ·ä½“éªŒæµ‹è¯•
- âœ… åŠ è½½çŠ¶æ€æ¸…æ™°
- âœ… é”™è¯¯æç¤ºå‹å¥½
- âœ… æˆåŠŸåé¦ˆåŠæ—¶
- âœ… æ“ä½œæµç¨‹é¡ºç•…

## ğŸ“ ä»£ç å˜æ›´

### ä¿®æ”¹çš„æ–‡ä»¶
- âœ… `app/components/GenerateSinglePage.tsx`
  - æ·»åŠ  `useImageIdentification` Hook
  - æ·»åŠ å›¾ç‰‡éªŒè¯é€»è¾‘
  - æ·»åŠ  MinIO ä¸Šä¼ é€»è¾‘
  - æ·»åŠ éªŒè¯çŠ¶æ€ UI

### ä½¿ç”¨çš„ Hook
- âœ… `useImageIdentification` - å›¾ç‰‡è¯†åˆ«
  - `identifyImages(images: string[])`
  - `isIdentifying` - è¯†åˆ«çŠ¶æ€

### æ–°å¢çŠ¶æ€
```typescript
const [uploadedImageUrl, setUploadedImageUrl] = useState<string | null>(null);
const [isValidatingImage, setIsValidatingImage] = useState(false);
```

### æ–°å¢å‡½æ•°
```typescript
uploadImageToMinio(dataUrl: string)          // ä¸Šä¼ åŸå›¾åˆ° MinIO
uploadGeneratedImageToMinio(imageDataUrl: string)  // ä¸Šä¼ ç”Ÿæˆå›¾åˆ° MinIO
```

## ğŸ¯ ä¼˜åŒ–æ•ˆæœ

### ç”¨æˆ·ä»·å€¼
1. **æ›´å®‰å…¨** - éªŒè¯å›¾ç‰‡åŒ…å«äººç‰©ï¼Œé¿å…æ— æ•ˆç”Ÿæˆ
2. **æ›´å¯é ** - å›¾ç‰‡è‡ªåŠ¨ä¿å­˜åˆ° MinIOï¼Œä¸ä¼šä¸¢å¤±
3. **æ›´æ¸…æ™°** - å®æ—¶çš„éªŒè¯çŠ¶æ€åé¦ˆ
4. **æ›´å‹å¥½** - è¯¦ç»†çš„é”™è¯¯æç¤ºå’Œæ“ä½œæŒ‡å¼•

### æŠ€æœ¯ä»·å€¼
1. **æ•°æ®æŒä¹…åŒ–** - å›¾ç‰‡å­˜å‚¨åœ¨å¯¹è±¡å­˜å‚¨ï¼Œä¸ä¾èµ–æµè§ˆå™¨
2. **å¯è¿½æº¯æ€§** - æ‰€æœ‰å›¾ç‰‡éƒ½æœ‰è®°å½•ï¼Œä¾¿äºç®¡ç†
3. **å¯æ‰©å±•æ€§** - ä¸ºæœªæ¥çš„åŠŸèƒ½ï¼ˆå¦‚å†å²è®°å½•ï¼‰æ‰“ä¸‹åŸºç¡€
4. **ä¸€è‡´æ€§** - ä¸ /create é¡µé¢çš„å¤„ç†æ–¹å¼ä¿æŒä¸€è‡´

## ğŸš€ æœªæ¥æ‰©å±•

### çŸ­æœŸ
1. æ·»åŠ ä¸Šä¼ è¿›åº¦æ˜¾ç¤º
2. æ”¯æŒæ‰¹é‡ä¸Šä¼ å’ŒéªŒè¯
3. æ·»åŠ å›¾ç‰‡ç¼–è¾‘åŠŸèƒ½ï¼ˆè£å‰ªã€æ—‹è½¬ï¼‰

### é•¿æœŸ
1. ä¿å­˜ç”Ÿæˆå†å²åˆ°æ•°æ®åº“
2. æ”¯æŒä»å†å²è®°å½•æ¢å¤
3. æ·»åŠ å›¾ç‰‡ç®¡ç†åŠŸèƒ½
4. æ”¯æŒå›¾ç‰‡åˆ†äº«

## âœ¨ æ€»ç»“

è¿™æ¬¡ä¼˜åŒ–æˆåŠŸä¸º"ç”Ÿæˆå•å¼ "åŠŸèƒ½æ·»åŠ äº†ï¼š
- âœ… æ™ºèƒ½çš„å›¾ç‰‡éªŒè¯ï¼ˆæ£€æµ‹äººç‰©ï¼‰
- âœ… è‡ªåŠ¨çš„å›¾ç‰‡ä¸Šä¼ ï¼ˆMinIO å­˜å‚¨ï¼‰
- âœ… å®Œå–„çš„çŠ¶æ€æç¤ºï¼ˆåŠ è½½ã€æˆåŠŸã€å¤±è´¥ï¼‰
- âœ… å‹å¥½çš„ç”¨æˆ·ä½“éªŒï¼ˆæ¸…æ™°çš„åé¦ˆï¼‰

æ‰€æœ‰åŠŸèƒ½éƒ½ç»è¿‡æµ‹è¯•ï¼Œä»£ç è´¨é‡ä¼˜ç§€ï¼Œå¯ä»¥ç«‹å³æŠ•å…¥ä½¿ç”¨ï¼ğŸ‰

