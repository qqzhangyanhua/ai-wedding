# 单张生成历史记录功能测试指南

## 测试前准备

### 1. 数据库迁移

在 Supabase SQL Editor 中执行迁移文件：

```sql
-- 执行 database-migrations/add_single_generations.sql
```

验证表已创建：
```sql
SELECT * FROM single_generations LIMIT 1;
```

### 2. 启动开发服务器

```bash
cd /Users/zhangyanhua/AI/ai-wedding
npm run dev
```

### 3. 确保已登录

- 访问 http://localhost:3000
- 如未登录，点击登录/注册
- 确保账户有足够积分（至少 15 积分）

## 测试场景

### 场景 1：生成并自动保存

**目标**：验证生成成功后自动保存到数据库

**步骤**：
1. 访问 http://localhost:3000/generate-single
2. 上传一张照片（JPG/PNG，< 10MB）
3. 输入提示词，例如：
   ```
   Transform this into a romantic wedding photo with soft lighting and elegant background
   ```
4. 选择设置：
   - 五官保持强度：高（推荐）
   - 创意程度：保守（推荐）
5. 点击"生成图片"按钮
6. 等待生成完成（观察流式输出）

**预期结果**：
- ✅ 图片生成成功
- ✅ 显示"图片生成完成并已保存！"提示
- ✅ 控制台显示"生成记录已保存到数据库"
- ✅ 无错误提示

**验证数据库**：
```sql
SELECT 
  id, 
  prompt, 
  settings,
  credits_used,
  created_at 
FROM single_generations 
ORDER BY created_at DESC 
LIMIT 1;
```

### 场景 2：Dashboard 展示历史记录

**目标**：验证 Dashboard 正确展示单张生成历史

**步骤**：
1. 访问 http://localhost:3000/dashboard
2. 点击"单张生成"标签页
3. 观察列表展示

**预期结果**：
- ✅ 显示"单张生成"标签页（带计数）
- ✅ 列表显示刚才生成的记录
- ✅ 卡片显示：
  - 提示词（截断显示）
  - 原图（左侧）
  - 结果图（右侧）
  - 创建时间
  - 消耗积分（15）
- ✅ 操作按钮可见（查看、下载、删除）

### 场景 3：查看详情

**目标**：验证详情模态框功能

**步骤**：
1. 在"单张生成"标签页
2. 点击某条记录的"查看详情"按钮（眼睛图标）
3. 观察模态框内容

**预期结果**：
- ✅ 模态框打开
- ✅ 左侧显示：
  - 完整提示词
  - 生成设置（五官保持强度、创意程度）
  - 创建时间
  - 消耗积分
  - 下载按钮
- ✅ 右侧显示：
  - 原图/结果图切换按钮
  - 大图预览
  - 对比缩略图
- ✅ 可以切换查看原图和结果图
- ✅ 点击关闭按钮可关闭模态框

### 场景 4：下载功能

**目标**：验证下载结果图功能

**步骤**：
1. 在卡片上点击"下载"按钮
2. 或在详情模态框中点击"下载结果图"按钮

**预期结果**：
- ✅ 浏览器开始下载
- ✅ 文件名格式：`single-generation-{id}.png`
- ✅ 图片可正常打开查看

### 场景 5：删除功能

**目标**：验证删除历史记录功能

**步骤**：
1. 在卡片上点击"删除"按钮（垃圾桶图标）
2. 确认删除对话框
3. 点击"确定"

**预期结果**：
- ✅ 显示确认对话框
- ✅ 确认后记录从列表中移除
- ✅ 显示"记录已删除"提示
- ✅ 标签页计数减 1

**验证数据库**：
```sql
SELECT COUNT(*) FROM single_generations WHERE user_id = '{your_user_id}';
```

### 场景 6：空状态展示

**目标**：验证无历史记录时的展示

**步骤**：
1. 删除所有单张生成记录
2. 刷新 Dashboard
3. 切换到"单张生成"标签页

**预期结果**：
- ✅ 显示空状态插图
- ✅ 显示"还没有单张生成记录"
- ✅ 显示"开始单张生成"按钮
- ✅ 点击按钮跳转到 `/generate-single`

### 场景 7：多条记录展示

**目标**：验证多条记录的展示和排序

**步骤**：
1. 生成 3-5 张图片（使用不同的提示词）
2. 访问 Dashboard 的"单张生成"标签页
3. 观察列表顺序

**预期结果**：
- ✅ 所有记录正确展示
- ✅ 按创建时间倒序排列（最新的在前）
- ✅ 每条记录的提示词、图片都正确显示
- ✅ 标签页计数正确

### 场景 8：标签页切换

**目标**：验证标签页切换功能

**步骤**：
1. 在 Dashboard 中
2. 依次切换：所有项目 → 已完成 → 单张生成
3. 观察内容变化

**预期结果**：
- ✅ 标签页切换流畅
- ✅ 每个标签页显示正确的内容
- ✅ 计数正确更新
- ✅ 刷新按钮在所有标签页都可用

### 场景 9：错误处理（数据库保存失败）

**目标**：验证数据库保存失败不影响生成流程

**步骤**：
1. 临时修改 RLS 策略使插入失败（仅测试环境）
2. 生成一张图片
3. 观察行为

**预期结果**：
- ✅ 图片正常生成
- ✅ 显示"图片生成完成！"（不显示保存失败）
- ✅ 控制台显示警告："保存生成记录到数据库失败（不影响主流程）"
- ✅ 用户体验不受影响

**恢复**：
```sql
-- 恢复 RLS 策略
DROP POLICY IF EXISTS "Users can insert own single generations" ON single_generations;
CREATE POLICY "Users can insert own single generations" 
  ON single_generations 
  FOR INSERT 
  TO authenticated 
  WITH CHECK (auth.uid() = user_id);
```

### 场景 10：权限隔离

**目标**：验证用户只能看到自己的记录

**步骤**：
1. 使用账户 A 生成几张图片
2. 登出，使用账户 B 登录
3. 访问 Dashboard 的"单张生成"标签页

**预期结果**：
- ✅ 账户 B 看不到账户 A 的记录
- ✅ 如果账户 B 没有记录，显示空状态
- ✅ RLS 策略正确工作

## 性能测试

### 测试加载性能

**步骤**：
1. 生成 20+ 条记录
2. 访问 Dashboard 的"单张生成"标签页
3. 观察加载时间

**预期结果**：
- ✅ 加载时间 < 2 秒
- ✅ 图片懒加载正常
- ✅ 无明显卡顿

## 浏览器兼容性测试

测试以下浏览器：
- [ ] Chrome（最新版）
- [ ] Firefox（最新版）
- [ ] Safari（最新版）
- [ ] Edge（最新版）

## 移动端测试

测试响应式布局：
- [ ] iPhone（Safari）
- [ ] Android（Chrome）
- [ ] 平板设备

**预期结果**：
- ✅ 布局自适应
- ✅ 卡片在小屏幕上单列显示
- ✅ 模态框在移动端可正常使用
- ✅ 触摸操作流畅

## 测试完成清单

### 功能测试
- [ ] 生成并自动保存
- [ ] Dashboard 展示历史记录
- [ ] 查看详情
- [ ] 下载功能
- [ ] 删除功能
- [ ] 空状态展示
- [ ] 多条记录展示
- [ ] 标签页切换
- [ ] 错误处理
- [ ] 权限隔离

### 非功能测试
- [ ] 性能测试
- [ ] 浏览器兼容性
- [ ] 移动端响应式

### 代码质量
- [ ] 无 TypeScript 错误
- [ ] 无 ESLint 错误
- [ ] 无控制台错误（除预期的警告）

## 问题报告模板

如发现问题，请记录：

```
### 问题描述
[简要描述问题]

### 复现步骤
1. 
2. 
3. 

### 预期结果
[应该发生什么]

### 实际结果
[实际发生了什么]

### 环境信息
- 浏览器：
- 操作系统：
- 用户 ID：
- 时间戳：

### 截图/日志
[附上相关截图或控制台日志]
```

## 测试完成

所有测试通过后：
1. 更新 TODO 状态为 completed
2. 提交代码到版本控制
3. 通知团队功能已就绪

## 后续监控

上线后需要监控：
- 数据库插入成功率
- 平均生成时间
- 用户使用频率
- 错误日志

