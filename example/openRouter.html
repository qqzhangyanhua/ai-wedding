<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIå›¾ç‰‡ç¼–è¾‘Demo</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      .header h1 {
        color: #333;
        font-size: 2.5rem;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .header p {
        color: #666;
        font-size: 1.1rem;
      }

      .demo-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .upload-section,
      .result-section {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        border: 2px dashed #ddd;
        transition: all 0.3s ease;
      }

      .upload-section:hover {
        border-color: #667eea;
        background: #f0f4ff;
      }

      .section-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .upload-area {
        border: 2px dashed #ccc;
        border-radius: 10px;
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 20px;
      }

      .upload-area:hover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.05);
      }

      .upload-area.dragover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.1);
      }

      .upload-icon {
        font-size: 3rem;
        color: #ccc;
        margin-bottom: 15px;
      }

      .upload-text {
        color: #666;
        font-size: 1.1rem;
        margin-bottom: 10px;
      }

      .upload-hint {
        color: #999;
        font-size: 0.9rem;
      }

      .file-input {
        display: none;
      }

      .image-preview {
        max-width: 100%;
        max-height: 300px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 15px;
      }

      .prompt-section {
        grid-column: 1 / -1;
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
      }

      .prompt-input {
        width: 100%;
        min-height: 120px;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 10px;
        font-size: 1rem;
        font-family: inherit;
        resize: vertical;
        transition: border-color 0.3s ease;
      }

      .prompt-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .generate-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 10px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 20px;
        width: 100%;
      }

      .generate-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
      }

      .generate-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .loading.show {
        display: block;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .result-image {
        max-width: 100%;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .error-message {
        background: #fee;
        color: #c33;
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
        border-left: 4px solid #c33;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      .success-message {
        background: #efe;
        color: #363;
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
        border-left: 4px solid #363;
        display: none;
      }

      .success-message.show {
        display: block;
      }

      .image-info {
        background: #fff;
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
        border: 1px solid #eee;
      }

      .info-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.9rem;
      }

      .info-label {
        font-weight: 600;
        color: #555;
      }

      .info-value {
        color: #777;
      }

      .result-image {
        max-width: 100%;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .result-image:hover {
        transform: scale(1.02);
        cursor: pointer;
      }

      .action-button {
        background: #667eea;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        margin-right: 8px;
      }

      .action-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      .action-button.success {
        background: #28a745;
      }

      .action-button.success:hover {
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
      }

      /* æ¨¡æ¿é€‰æ‹©æ ·å¼ */
      .template-section {
        grid-column: 1 / -1;
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
      }

      .template-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }

      .template-card {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 3px solid transparent;
      }

      .template-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
      }

      .template-card.selected {
        border-color: #667eea;
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
      }

      .template-preview {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #f0f0f0;
      }

      .template-info {
        padding: 12px;
        text-align: center;
      }

      .template-name {
        font-size: 0.9rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
      }

      .template-category {
        font-size: 0.75rem;
        color: #999;
        text-transform: uppercase;
      }

      .prompt-list-section {
        margin-top: 15px;
        padding: 15px;
        background: #fff;
        border-radius: 10px;
        display: none;
      }

      .prompt-list-section.show {
        display: block;
      }

      .prompt-item {
        padding: 12px;
        margin-bottom: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
        font-size: 0.85rem;
        line-height: 1.5;
        color: #555;
      }

      .prompt-item:hover {
        background: #e9ecef;
        border-color: #667eea;
      }

      .prompt-item.selected {
        background: #e3e8ff;
        border-color: #667eea;
        color: #333;
      }

      .prompt-item-number {
        display: inline-block;
        width: 24px;
        height: 24px;
        line-height: 24px;
        text-align: center;
        background: #667eea;
        color: white;
        border-radius: 50%;
        font-size: 0.75rem;
        font-weight: bold;
        margin-right: 8px;
      }

      @media (max-width: 768px) {
        .demo-grid {
          grid-template-columns: 1fr;
        }

        .header h1 {
          font-size: 2rem;
        }

        .container {
          padding: 20px;
        }

        .template-grid {
          grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <!-- å¼•å…¥æ¨¡æ¿æ•°æ® -->
    <script src="template-data.js"></script>
    
    <div class="container">
      <div class="header">
        <h1>ğŸ¨ AIå›¾ç‰‡ç¼–è¾‘Demo</h1>
        <p>ä¸Šä¼ å›¾ç‰‡ï¼Œè¾“å…¥æç¤ºè¯ï¼Œè®©AIä¸ºä½ åˆ›é€ å…¨æ–°çš„å›¾ç‰‡æ•ˆæœ</p>
      </div>

      <div class="demo-grid">
        <!-- æ¨¡æ¿é€‰æ‹©åŒºåŸŸ -->
        <div class="template-section">
          <div class="section-title">ğŸ¨ é€‰æ‹©å©šçº±ç…§é£æ ¼æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰</div>
          <div class="template-grid" id="templateGrid">
            <div style="padding: 40px; text-align: center; grid-column: 1 / -1; color: #999;">
              <div class="spinner"></div>
              <div style="margin-top: 15px;">åŠ è½½æ¨¡æ¿ä¸­...</div>
            </div>
          </div>
          <!-- æç¤ºè¯åˆ—è¡¨ -->
          <div class="prompt-list-section" id="promptListSection">
            <div style="font-weight: 600; color: #333; margin-bottom: 12px; font-size: 1rem;">
              ğŸ“ é€‰æ‹©æç¤ºè¯ï¼ˆç‚¹å‡»å³å¯ä½¿ç”¨ï¼‰
            </div>
            <div id="promptList"></div>
          </div>
        </div>

        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-section">
          <div class="section-title">ğŸ“¸ ä¸Šä¼ åŸå›¾</div>
          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“</div>
            <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</div>
            <div class="upload-hint">æ”¯æŒ JPG, PNG, WebP æ ¼å¼ï¼Œæœ€å¤§ 10MB</div>
            <input
              type="file"
              class="file-input"
              id="fileInput"
              accept="image/*"
            />
          </div>
          <div id="originalImageContainer" style="display: none">
            <img id="originalImage" class="image-preview" alt="åŸå›¾é¢„è§ˆ" />
            <div class="image-info" id="originalImageInfo"></div>
          </div>
        </div>

        <!-- ç»“æœåŒºåŸŸ -->
        <div class="result-section">
          <div class="section-title">âœ¨ ç¼–è¾‘ç»“æœ</div>
          <div id="resultContainer">
            <div style="text-align: center; color: #999; padding: 40px">
              <div style="font-size: 3rem; margin-bottom: 15px">ğŸ–¼ï¸</div>
              <div>ç¼–è¾‘åçš„å›¾ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>
            </div>
          </div>
          <div class="loading" id="loading">
            <div class="spinner"></div>
            <div id="loadingText">AIæ­£åœ¨åˆ†æå›¾ç‰‡ï¼Œæµå¼ç”Ÿæˆä¸­...</div>
            <div id="processingInfo" style="margin-top: 10px; font-size: 0.9rem; color: #999;"></div>
          </div>
        </div>

        <!-- æç¤ºè¯åŒºåŸŸ -->
        <div class="prompt-section">
          <div class="section-title">ğŸ’­ ç¼–è¾‘æç¤ºè¯</div>
          <textarea
            class="prompt-input"
            id="promptInput"
            placeholder="è¯·ç”¨è‹±æ–‡æè¿°ä½ æƒ³è¦çš„å›¾ç‰‡æ•ˆæœï¼Œä¾‹å¦‚ï¼š&#10;- Change the background to a sunset beach scene&#10;- Add sunglasses and a hat to the person&#10;- Convert the image to oil painting style&#10;- Remove clutter from the background&#10;- Change the clothing color to red&#10;- Add professional lighting effects&#10;- Transform into vintage photography style&#10;&#10;ğŸ’¡ é‡è¦æç¤ºï¼š&#10;- è¯·ä½¿ç”¨è‹±æ–‡æè¿°ä»¥è·å¾—æ›´å¥½æ•ˆæœ&#10;- ç³»ç»Ÿä¼šè‡ªåŠ¨ä¿æŠ¤äººç‰©çš„äº”å®˜ç‰¹å¾&#10;- æè¿°è¶Šè¯¦ç»†ï¼Œæ•ˆæœè¶Šå¥½"
          ></textarea>
          <!-- é«˜çº§è®¾ç½® -->
          <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
            <div style="font-weight: 600; color: #333; margin-bottom: 10px; font-size: 0.9rem;">âš™ï¸ é«˜çº§è®¾ç½®</div>
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
              <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; color: #666;">
                <span>äº”å®˜ä¿æŒå¼ºåº¦:</span>
                <select id="facePreservation" style="padding: 5px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9rem;">
                  <option value="high">é«˜ (æ¨è)</option>
                  <option value="medium">ä¸­</option>
                  <option value="low">ä½</option>
                </select>
              </label>
              <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; color: #666;">
                <span>åˆ›æ„ç¨‹åº¦:</span>
                <select id="creativityLevel" style="padding: 5px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9rem;">
                  <option value="conservative">ä¿å®ˆ (æ¨è)</option>
                  <option value="balanced">å¹³è¡¡</option>
                  <option value="creative">åˆ›æ„</option>
                </select>
              </label>
            </div>
          </div>

          <button class="generate-btn" id="generateBtn" disabled>
            ğŸš€ å¼€å§‹AIç¼–è¾‘
          </button>

          <div class="error-message" id="errorMessage"></div>
          <div class="success-message" id="successMessage"></div>
        </div>
      </div>
    </div>

    <script>
      class ImageEditDemo {
        constructor() {
          this.originalImage = null;
          this.originalImageData = null;
          this.templates = [];
          this.selectedTemplate = null;
          this.selectedPrompt = null;
          this.initializeElements();
          this.bindEvents();
          this.loadTemplates();
        }

        initializeElements() {
          this.uploadArea = document.getElementById("uploadArea");
          this.fileInput = document.getElementById("fileInput");
          this.originalImageContainer = document.getElementById(
            "originalImageContainer"
          );
          this.originalImageElement = document.getElementById("originalImage");
          this.originalImageInfo = document.getElementById("originalImageInfo");
          this.promptInput = document.getElementById("promptInput");
          this.generateBtn = document.getElementById("generateBtn");
          this.loading = document.getElementById("loading");
          this.resultContainer = document.getElementById("resultContainer");
          this.errorMessage = document.getElementById("errorMessage");
          this.successMessage = document.getElementById("successMessage");
          this.facePreservation = document.getElementById("facePreservation");
          this.creativityLevel = document.getElementById("creativityLevel");
          this.templateGrid = document.getElementById("templateGrid");
          this.promptListSection = document.getElementById("promptListSection");
          this.promptList = document.getElementById("promptList");
        }

        bindEvents() {
          // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
          this.uploadArea.addEventListener("click", () =>
            this.fileInput.click()
          );
          this.fileInput.addEventListener("change", (e) =>
            this.handleFileSelect(e)
          );

          // æ‹–æ‹½ä¸Šä¼ 
          this.uploadArea.addEventListener("dragover", (e) =>
            this.handleDragOver(e)
          );
          this.uploadArea.addEventListener("dragleave", (e) =>
            this.handleDragLeave(e)
          );
          this.uploadArea.addEventListener("drop", (e) => this.handleDrop(e));

          // æç¤ºè¯è¾“å…¥
          this.promptInput.addEventListener("input", () => this.validateForm());

          // ç”ŸæˆæŒ‰é’®
          this.generateBtn.addEventListener("click", () =>
            this.generateImage()
          );
        }

        loadTemplates() {
          try {
            // ä»å…¨å±€å˜é‡è¯»å–æ¨¡æ¿æ•°æ®
            this.templates = window.TEMPLATE_DATA || [];
            
            if (this.templates.length === 0) {
              throw new Error('æ¨¡æ¿æ•°æ®ä¸ºç©º');
            }
            
            this.renderTemplates();
          } catch (error) {
            console.error('åŠ è½½æ¨¡æ¿å¤±è´¥:', error);
            this.templateGrid.innerHTML = `
              <div style="padding: 40px; text-align: center; grid-column: 1 / -1; color: #c33;">
                <div style="font-size: 2rem; margin-bottom: 10px;">âŒ</div>
                <div>åŠ è½½æ¨¡æ¿å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>
              </div>
            `;
          }
        }

        renderTemplates() {
          if (this.templates.length === 0) {
            this.templateGrid.innerHTML = `
              <div style="padding: 40px; text-align: center; grid-column: 1 / -1; color: #999;">
                <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“­</div>
                <div>æš‚æ— æ¨¡æ¿</div>
              </div>
            `;
            return;
          }

          this.templateGrid.innerHTML = this.templates.map((template, index) => `
            <div class="template-card" data-template-id="${template.id}" data-index="${index}">
              <img src="${template.preview_image_url}" alt="${template.name}" class="template-preview" 
                   onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22%3E%3Crect fill=%22%23f0f0f0%22 width=%22200%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2216%22%3Eæš‚æ— å›¾ç‰‡%3C/text%3E%3C/svg%3E'">
              <div class="template-info">
                <div class="template-name">${template.name}</div>
                <div class="template-category">${this.getCategoryName(template.category)}</div>
              </div>
            </div>
          `).join('');

          // ç»‘å®šç‚¹å‡»äº‹ä»¶
          this.templateGrid.querySelectorAll('.template-card').forEach(card => {
            card.addEventListener('click', () => {
              const templateId = card.dataset.templateId;
              const index = parseInt(card.dataset.index);
              this.selectTemplate(templateId, index);
            });
          });
        }

        getCategoryName(category) {
          const categoryMap = {
            'classic': 'ç»å…¸',
            'artistic': 'è‰ºæœ¯',
            'location': 'å¤–æ™¯',
            'fantasy': 'åˆ›æ„'
          };
          return categoryMap[category] || category;
        }

        selectTemplate(templateId, index) {
          // æ›´æ–°é€‰ä¸­çŠ¶æ€
          this.templateGrid.querySelectorAll('.template-card').forEach(card => {
            card.classList.remove('selected');
          });
          this.templateGrid.querySelector(`[data-template-id="${templateId}"]`).classList.add('selected');

          // ä¿å­˜é€‰ä¸­çš„æ¨¡æ¿
          this.selectedTemplate = this.templates[index];
          
          // æ˜¾ç¤ºæç¤ºè¯åˆ—è¡¨
          this.renderPromptList();
          this.promptListSection.classList.add('show');
        }

        renderPromptList() {
          if (!this.selectedTemplate || !this.selectedTemplate.prompt_list || this.selectedTemplate.prompt_list.length === 0) {
            this.promptList.innerHTML = `
              <div style="padding: 20px; text-align: center; color: #999;">
                è¯¥æ¨¡æ¿æš‚æ— æç¤ºè¯
              </div>
            `;
            return;
          }

          this.promptList.innerHTML = this.selectedTemplate.prompt_list.map((prompt, index) => `
            <div class="prompt-item" data-prompt-index="${index}">
              <span class="prompt-item-number">${index + 1}</span>
              ${prompt}
            </div>
          `).join('');

          // ç»‘å®šç‚¹å‡»äº‹ä»¶
          this.promptList.querySelectorAll('.prompt-item').forEach(item => {
            item.addEventListener('click', () => {
              const promptIndex = parseInt(item.dataset.promptIndex);
              this.selectPrompt(promptIndex);
            });
          });
        }

        selectPrompt(index) {
          // æ›´æ–°é€‰ä¸­çŠ¶æ€
          this.promptList.querySelectorAll('.prompt-item').forEach(item => {
            item.classList.remove('selected');
          });
          this.promptList.querySelector(`[data-prompt-index="${index}"]`).classList.add('selected');

          // å°†æç¤ºè¯å¡«å…¥è¾“å…¥æ¡†
          this.selectedPrompt = this.selectedTemplate.prompt_list[index];
          this.promptInput.value = this.selectedPrompt;
          
          // éªŒè¯è¡¨å•
          this.validateForm();
          
          // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
          this.showSuccess('å·²é€‰æ‹©æç¤ºè¯ï¼Œæ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨æˆ–è¿›è¡Œä¿®æ”¹');
          
          // è‡ªåŠ¨æ»šåŠ¨åˆ°æç¤ºè¯è¾“å…¥åŒºåŸŸ
          setTimeout(() => {
            this.promptInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        }

        handleDragOver(e) {
          e.preventDefault();
          this.uploadArea.classList.add("dragover");
        }

        handleDragLeave(e) {
          e.preventDefault();
          this.uploadArea.classList.remove("dragover");
        }

        handleDrop(e) {
          e.preventDefault();
          this.uploadArea.classList.remove("dragover");
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            this.processFile(files[0]);
          }
        }

        handleFileSelect(e) {
          const file = e.target.files[0];
          if (file) {
            this.processFile(file);
          }
        }

        processFile(file) {
          // éªŒè¯æ–‡ä»¶ç±»å‹
          if (!file.type.startsWith("image/")) {
            this.showError("è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼");
            return;
          }

          // éªŒè¯æ–‡ä»¶å¤§å° (10MB)
          if (file.size > 10 * 1024 * 1024) {
            this.showError("å›¾ç‰‡æ–‡ä»¶ä¸èƒ½è¶…è¿‡10MBï¼");
            return;
          }

          this.hideMessages();

          const reader = new FileReader();
          reader.onload = (e) => {
            this.originalImageData = e.target.result;
            this.displayOriginalImage(e.target.result, file);
            this.validateForm();
          };
          reader.readAsDataURL(file);
        }

        displayOriginalImage(dataUrl, file) {
          this.originalImageElement.src = dataUrl;
          this.originalImageContainer.style.display = "block";

          // æ˜¾ç¤ºå›¾ç‰‡ä¿¡æ¯
          const fileSize = (file.size / 1024 / 1024).toFixed(2);
          this.originalImageInfo.innerHTML = `
                    <div class="info-item">
                        <span class="info-label">æ–‡ä»¶å:</span>
                        <span class="info-value">${file.name}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æ–‡ä»¶å¤§å°:</span>
                        <span class="info-value">${fileSize} MB</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æ–‡ä»¶ç±»å‹:</span>
                        <span class="info-value">${file.type}</span>
                    </div>
                `;

          // è·å–å›¾ç‰‡å°ºå¯¸
          const img = new Image();
          img.onload = () => {
            this.originalImageInfo.innerHTML += `
                        <div class="info-item">
                            <span class="info-label">å›¾ç‰‡å°ºå¯¸:</span>
                            <span class="info-value">${img.width} Ã— ${img.height}</span>
                        </div>
                    `;
          };
          img.src = dataUrl;
        }

        validateForm() {
          const hasImage = this.originalImageData !== null;
          const hasPrompt = this.promptInput.value.trim().length > 0;
          this.generateBtn.disabled = !(hasImage && hasPrompt);
        }

        async generateImage() {
          if (!this.originalImageData || !this.promptInput.value.trim()) {
            this.showError("è¯·å…ˆä¸Šä¼ å›¾ç‰‡å¹¶è¾“å…¥æç¤ºè¯ï¼");
            return;
          }

          this.hideMessages();
          this.showLoading(true);
          this.generateBtn.disabled = true;

          try {
            // å‡†å¤‡APIè¯·æ±‚æ•°æ®
            const base64Image = this.originalImageData.split(",")[1]; // ç§»é™¤data:image/...;base64,å‰ç¼€
            const prompt = this.promptInput.value.trim();

            // è·å–ç”¨æˆ·è®¾ç½®
            const facePreservationLevel = this.facePreservation.value;
            const creativityLevel = this.creativityLevel.value;

            // æ ¹æ®è®¾ç½®æ„å»ºä¸åŒå¼ºåº¦çš„æç¤ºè¯ï¼ˆè‹±æ–‡ï¼‰
            let facePreservationText = "";
            switch (facePreservationLevel) {
              case "high":
                facePreservationText = `STRICT REQUIREMENTS:
1. ABSOLUTELY preserve all facial features, facial contours, eye shape, nose shape, mouth shape, and all key characteristics from the original image
2. Maintain the person's basic facial structure and proportions COMPLETELY unchanged
3. Ensure the person in the edited image is 100% recognizable as the same individual
4. NO changes to any facial details including skin texture, moles, scars, or other distinctive features
5. If style conversion is involved, MUST maintain facial realism and accuracy
6. Focus ONLY on non-facial modifications as requested`;
                break;
              case "medium":
                facePreservationText = `REQUIREMENTS:
1. Preserve the main facial features and facial contours from the original image
2. Maintain the person's basic facial structure and proportions
3. Ensure the person in the edited image is recognizable as the same individual
4. Allow minor facial detail adjustments but do not change overall characteristics
5. Prioritize facial preservation over stylistic changes`;
                break;
              case "low":
                facePreservationText = `BASIC REQUIREMENTS:
1. Try to preserve the main facial features from the original image
2. Maintain the basic facial contours of the person
3. Allow some degree of facial adjustment and stylization while keeping general likeness`;
                break;
            }

            // æ„å»ºä¼˜åŒ–çš„æç¤ºè¯ï¼ˆè‹±æ–‡ï¼‰
            const enhancedPrompt = `Please edit the provided original image based on the following guidelines:

${facePreservationText}

SPECIFIC EDITING REQUEST: ${prompt}

Please focus your modifications ONLY on the user's specific requirements while strictly following the face preservation guidelines above. Generate a high-quality edited image that maintains facial identity.`;

            // æ ¹æ®åˆ›æ„ç¨‹åº¦è®¾ç½®å‚æ•°
            let temperature, topP;
            switch (creativityLevel) {
              case "conservative":
                temperature = 0.2;
                topP = 0.7;
                break;
              case "balanced":
                temperature = 0.5;
                topP = 0.85;
                break;
              case "creative":
                temperature = 0.8;
                topP = 0.95;
                break;
            }

            const requestData = {
              model: "google/gemini-2.5-flash-image",
              temperature: temperature, // æ ¹æ®åˆ›æ„ç¨‹åº¦åŠ¨æ€è°ƒæ•´
              top_p: topP, // æ ¹æ®åˆ›æ„ç¨‹åº¦åŠ¨æ€è°ƒæ•´
              messages: [
                {
                  role: "user",
                  content: [
                    {
                      type: "text",
                      text: enhancedPrompt,
                    },
                    {
                      type: "image_url",
                      image_url: {
                        url: `data:image/jpeg;base64,${base64Image}`,
                      },
                    },
                  ],
                },
              ],
              stream: true,
              stream_options: {
                include_usage: true,
              },
            };

            // è°ƒç”¨API
            const response = await fetch(
              "https://openrouter.ai/api/v1/chat/completions",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization:
                    "Bearer s84152c275c8",
                },
                body: JSON.stringify(requestData),
              }
            );

            if (!response.ok) {
              throw new Error(
                `APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`
              );
            }

            // å¤„ç†æµå¼å“åº”ï¼ˆå¢å¼ºçš„ SSE è§£æï¼Œè·¨ chunk ç¼“å†²ä¸äº‹ä»¶è¾¹ç•Œå¤„ç†ï¼‰
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let content = ""; // èšåˆæ–‡æœ¬å†…å®¹ï¼ˆåŒ…æ‹¬ markdown å›¾ç‰‡ï¼‰
            let isStreamComplete = false; // æ ‡è®°æ˜¯å¦åœæ­¢
            let sseBuffer = ""; // è·¨ chunk çš„ç¼“å†²åŒº
            let processingCount = 0; // è®°å½• PROCESSING å‡ºç°æ¬¡æ•°

            while (true) {
              const { done, value } = await reader.read();
              if (done) {
                // è¯»å®Œåå°è¯•å¤„ç†ç¼“å†²ä¸­å‰©ä½™çš„å®Œæ•´äº‹ä»¶
                if (sseBuffer.trim().length > 0) {
                  sseBuffer += "\n\n"; // å¼ºåˆ¶ä½œä¸ºä¸€ä¸ªäº‹ä»¶è¾¹ç•Œæ”¶å°¾
                }
              } else {
                // æŒ‰æµå¼è¿½åŠ è§£ç ï¼Œä¿ç•™ä¸å®Œæ•´å°¾éƒ¨
                sseBuffer += decoder.decode(value, { stream: true });
              }

              // æŒ‰ SSE äº‹ä»¶è¾¹ç•Œï¼ˆç©ºè¡Œï¼‰æ‹†åˆ†
              let events = sseBuffer.split(/\n\n/);
              // æœ€åä¸€æ®µå¯èƒ½æ˜¯ä¸å®Œæ•´äº‹ä»¶ï¼Œç•™ä¸‹ç»™ä¸‹ä¸€è½®
              sseBuffer = events.pop() || "";

              for (const evt of events) {
                // æ”¯æŒå¤šè¡Œ data: æƒ…å†µï¼Œå°†æ‰€æœ‰ data: è¡Œæ‹¼æ¥
                const dataLines = evt
                  .split(/\n/)
                  .filter((l) => l.startsWith("data:"))
                  .map((l) => l.slice(5).trimStart()); // å»æ‰å†’å·ï¼Œä¿ç•™å…¼å®¹ data:ä¸data: â½©ç©º

                if (dataLines.length === 0) continue;

                // å¤š data: è¡ŒæŒ‰æ¢è¡Œåˆå¹¶ï¼ˆSSE è§„èŒƒï¼‰
                const dataPayload = dataLines.join("\n").trim();

                if (dataPayload === "[DONE]") {
                  isStreamComplete = true;
                  continue;
                }

                try {
                  // è°ƒè¯•ï¼šæ‰“å°åŸå§‹æ•°æ®ï¼ˆå‰200å­—ç¬¦ï¼‰
                  console.log("ğŸ“¨ åŸå§‹æ•°æ®:", dataPayload.substring(0, 200));
                  const parsed = JSON.parse(dataPayload);
                  
                  // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
                  if (parsed.error) {
                    console.error("âŒ APIè¿”å›é”™è¯¯:", parsed.error);
                    const errorMsg = parsed.error.message || "æœªçŸ¥é”™è¯¯";
                    const errorCode = parsed.error.code || "";
                    
                    // ç‰¹æ®Šå¤„ç†åœ°ç†ä½ç½®é™åˆ¶é”™è¯¯
                    if (errorMsg.includes("User location is not supported")) {
                      throw new Error(`åœ°ç†ä½ç½®é™åˆ¶ï¼š${errorMsg}\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. ä½¿ç”¨VPN/ä»£ç†ï¼ˆæ¨èç¾å›½èŠ‚ç‚¹ï¼‰\n2. æˆ–æ›´æ¢å…¶ä»–æ¨¡å‹ï¼ˆå¦‚ openai/gpt-4oï¼‰`);
                    } else {
                      throw new Error(`APIé”™è¯¯ (${errorCode}): ${errorMsg}`);
                    }
                  }
                  
                  // è°ƒè¯•ï¼šæ‰“å°è§£æåçš„æ•°æ®ç»“æ„
                  console.log("ğŸ“¦ è§£æåˆ°çš„æ•°æ®ç»“æ„:", {
                    hasChoices: !!parsed.choices,
                    hasChoice0: !!(parsed.choices && parsed.choices[0]),
                    hasDelta: !!(parsed.choices && parsed.choices[0] && parsed.choices[0].delta),
                    hasMessage: !!(parsed.choices && parsed.choices[0] && parsed.choices[0].message),
                    finishReason: parsed.choices && parsed.choices[0] && parsed.choices[0].finish_reason
                  });
                  
                  // å¤„ç†æµå¼å¢é‡å†…å®¹ï¼ˆdeltaï¼‰
                  if (parsed.choices && parsed.choices[0] && parsed.choices[0].delta) {
                    const delta = parsed.choices[0].delta;
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡æ•°æ®ï¼ˆimagesæ•°ç»„ï¼‰
                    if (delta.images && Array.isArray(delta.images) && delta.images.length > 0) {
                      console.log("âœ… åœ¨Deltaä¸­æ£€æµ‹åˆ°imagesæ•°ç»„ï¼Œé•¿åº¦:", delta.images.length);
                      for (const img of delta.images) {
                        if (img.image_url && img.image_url.url) {
                          console.log("âœ… æ‰¾åˆ°å›¾ç‰‡URLï¼Œé•¿åº¦:", img.image_url.url.length);
                          // ç›´æ¥ä¿å­˜å›¾ç‰‡URL
                          content = img.image_url.url;
                          break;
                        }
                      }
                    }
                    // å¤„ç†æ–‡æœ¬å†…å®¹
                    else if (delta.content) {
                      const deltaContent = delta.content;
                      console.log("ğŸ“ Deltaæ–‡æœ¬å†…å®¹:", typeof deltaContent, deltaContent.substring ? deltaContent.substring(0, 100) : deltaContent);
                      
                      // è¿‡æ»¤æ‰ OPENROUTER PROCESSING æ ‡è®°
                      if (typeof deltaContent === 'string' && deltaContent.includes("OPENROUTER PROCESSING")) {
                        processingCount++;
                        // æ›´æ–°å¤„ç†çŠ¶æ€æ˜¾ç¤º
                        this.updateProcessingStatus(processingCount);
                        continue; // è·³è¿‡è¿™ä¸ªå†…å®¹ï¼Œä¸æ·»åŠ åˆ°æœ€ç»ˆç»“æœ
                      }
                      
                      // å¤„ç†å­—ç¬¦ä¸²ç±»å‹çš„delta
                      if (typeof deltaContent === 'string') {
                        content += deltaContent;
                        // å®æ—¶æ›´æ–°æ˜¾ç¤ºå†…å®¹ï¼ˆä½†ä¸å°è¯•æ¸²æŸ“å›¾ç‰‡ï¼‰
                        this.updateStreamingContent(content, false);
                      }
                    }
                  }
                  
                  // å¤„ç†å®Œæ•´çš„æ¶ˆæ¯å†…å®¹ï¼ˆmessage.contentï¼‰- é€šå¸¸åœ¨æœ€åä¸€ä¸ªchunk
                  if (
                    parsed.choices &&
                    parsed.choices[0] &&
                    parsed.choices[0].message &&
                    parsed.choices[0].message.content
                  ) {
                    console.log("âœ… æ£€æµ‹åˆ°å®Œæ•´æ¶ˆæ¯å†…å®¹");
                    const messageContent = parsed.choices[0].message.content;
                    console.log("ğŸ“ Messageå†…å®¹ç±»å‹:", typeof messageContent, Array.isArray(messageContent) ? `æ•°ç»„é•¿åº¦:${messageContent.length}` : '');
                    
                    // å¦‚æœæ˜¯æ•°ç»„æ ¼å¼ï¼ˆåŒ…å«å›¾ç‰‡æ•°æ®ï¼‰
                    if (Array.isArray(messageContent)) {
                      for (const item of messageContent) {
                        console.log("ğŸ“ æ•°ç»„é¡¹:", item.type, item.source ? 'æœ‰source' : 'æ— source');
                        if (item.type === 'image' && item.source && item.source.data) {
                          console.log("âœ… åœ¨æµå¼å“åº”ä¸­æ£€æµ‹åˆ°å›¾ç‰‡æ•°æ®ï¼Œæ•°æ®é•¿åº¦:", item.source.data.length);
                          content = JSON.stringify({ content: messageContent });
                          break;
                        }
                      }
                    } else if (typeof messageContent === 'string') {
                      // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œè¿½åŠ åˆ°content
                      console.log("ğŸ“ Messageæ˜¯å­—ç¬¦ä¸²ï¼Œé•¿åº¦:", messageContent.length);
                      content += messageContent;
                    }
                  }

                  // æ£€æŸ¥æ˜¯å¦æµå¼ç»“æŸ
                  if (
                    parsed.choices &&
                    parsed.choices[0] &&
                    parsed.choices[0].finish_reason === "stop"
                  ) {
                    console.log("ğŸ æ£€æµ‹åˆ°æµå¼ç»“æŸæ ‡è®°");
                    isStreamComplete = true;
                  }
                } catch (e) {
                  // JSON å¯èƒ½è·¨ chunk è¢«æˆªæ–­ï¼Œä¿ç•™åœ¨ sseBuffer å·²å¤„ç†
                  console.warn("è§£ææµå¼æ•°æ®å¤±è´¥ï¼Œå·²å¿½ç•¥è¯¥äº‹ä»¶:", e);
                }
              }

              if (done) break;
            }

            // æ¸…ç†æœ€ç»ˆå†…å®¹
            const finalContent = content.replace(/:\s*OPENROUTER\s+PROCESSING\s*/gi, '').trim();
            
            console.log("æµå¼æ¥æ”¶å®Œæˆ");
            console.log("åŸå§‹å†…å®¹é•¿åº¦:", content.length);
            console.log("æ¸…ç†åå†…å®¹é•¿åº¦:", finalContent.length);
            console.log("PROCESSINGæ ‡è®°å‡ºç°æ¬¡æ•°:", processingCount);
            console.log("å†…å®¹å‰100å­—ç¬¦:", finalContent.substring(0, 100));
            
            if (finalContent) {
              // æµå¼å®Œæˆåè¿›è¡Œæœ€ç»ˆè§£æå’Œæ¸²æŸ“
              this.finalizeStreamingContent(finalContent);
              this.showSuccess("å›¾ç‰‡ç¼–è¾‘å®Œæˆï¼");
            } else if (content.length > 0) {
              // å¦‚æœæœ‰åŸå§‹å†…å®¹ä½†æ¸…ç†åä¸ºç©ºï¼Œè¯´æ˜åªæœ‰PROCESSINGæ ‡è®°
              console.warn("âš ï¸ å†…å®¹åªåŒ…å«PROCESSINGæ ‡è®°ï¼Œæ²¡æœ‰å®é™…æ•°æ®");
              this.showError("AIå¤„ç†å®Œæˆï¼Œä½†æœªè¿”å›æœ‰æ•ˆå†…å®¹ã€‚å¯èƒ½éœ€è¦é‡è¯•ã€‚");
            } else {
              throw new Error("APIè¿”å›æ•°æ®ä¸ºç©º");
            }
          } catch (error) {
            console.error("ç”Ÿæˆå›¾ç‰‡å¤±è´¥:", error);
            this.showError(`ç”Ÿæˆå¤±è´¥: ${error.message}`);
          } finally {
            this.showLoading(false);
            this.generateBtn.disabled = false;
          }
        }

        renderImageResult(imageDataUrl, imageType, base64String, originalContent = '') {
          console.log(
            "ğŸ“Š å›¾ç‰‡ç±»å‹:",
            imageType,
            "| æ•°æ®é•¿åº¦:",
            base64String.length,
            "| é¢„ä¼°å¤§å°:",
            Math.round((base64String.length * 0.75) / 1024) + "KB"
          );

          this.resultContainer.innerHTML = `
            <div style="text-align: center; margin-bottom: 20px;">
              <img src="${imageDataUrl}" class="result-image" alt="AIç¼–è¾‘åçš„å›¾ç‰‡" id="resultImage" 
                   onload="console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ')" 
                   onerror="console.error('å›¾ç‰‡åŠ è½½å¤±è´¥'); this.style.display='none'; this.nextElementSibling.style.display='block';">
              <div style="display: none; color: #c33; padding: 20px; background: #fee; border-radius: 10px;">
                å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ˜¯æ•°æ®æ ¼å¼é—®é¢˜
              </div>
            </div>
            <div class="image-info">
              <div class="info-item">
                <span class="info-label">ç”Ÿæˆæ—¶é—´:</span>
                <span class="info-value">${new Date().toLocaleString()}</span>
              </div>
              <div class="info-item">
                <span class="info-label">å›¾ç‰‡æ ¼å¼:</span>
                <span class="info-value">${imageType.toUpperCase()}</span>
              </div>
              <div class="info-item">
                <span class="info-label">å›¾ç‰‡å¤§å°:</span>
                <span class="info-value">${Math.round((base64String.length * 0.75) / 1024)} KB</span>
              </div>
              <div class="info-item">
                <span class="info-label">æ•°æ®é•¿åº¦:</span>
                <span class="info-value">${base64String.length} å­—ç¬¦</span>
              </div>
              <div class="info-item">
                <span class="info-label">æ“ä½œ:</span>
                <span class="info-value">
                  <button id="downloadBtn" class="action-button" data-base64="${imageDataUrl}" data-filename="ai-edited-image.${imageType}">
                    ğŸ“¥ ä¸‹è½½å›¾ç‰‡
                  </button>
                  <button id="copyBtn" class="action-button success" data-base64="${base64String}">
                    ğŸ“‹ å¤åˆ¶Base64
                  </button>
                  <button id="debugBtn" class="action-button" style="background: #6c757d;">
                    ğŸ” è°ƒè¯•ä¿¡æ¯
                  </button>
                </span>
              </div>
            </div>
          `;

          // ç»‘å®šæŒ‰é’®äº‹ä»¶
          setTimeout(() => {
            const downloadBtn = document.getElementById("downloadBtn");
            const copyBtn = document.getElementById("copyBtn");
            const debugBtn = document.getElementById("debugBtn");
            const resultImage = document.getElementById("resultImage");

            if (downloadBtn) {
              downloadBtn.addEventListener("click", () => {
                const base64Data = downloadBtn.getAttribute("data-base64");
                const filename = downloadBtn.getAttribute("data-filename");
                this.downloadBase64Image(base64Data, filename);
              });
            }

            if (copyBtn) {
              copyBtn.addEventListener("click", () => {
                const base64String = copyBtn.getAttribute("data-base64");
                this.copyBase64ToClipboard(base64String);
              });
            }

            if (debugBtn) {
              debugBtn.addEventListener("click", () => {
                this.showDebugInfo(originalContent || base64String, base64String);
              });
            }

            if (resultImage) {
              resultImage.addEventListener("click", () => {
                this.openImagePreview(resultImage.src);
              });
            }
          }, 100);
        }

        displayResult(content) {
          console.log("å¼€å§‹è§£æå†…å®¹ï¼Œæ€»é•¿åº¦:", content.length);
          console.log("å†…å®¹é¢„è§ˆ:", content.substring(0, 200) + "...");

          // æ¸…ç†å†…å®¹ï¼šç§»é™¤æ‰€æœ‰ OPENROUTER PROCESSING æ ‡è®°
          const cleanedContent = content.replace(/:\s*OPENROUTER\s+PROCESSING\s*/gi, '').trim();
          console.log("æ¸…ç†åå†…å®¹é•¿åº¦:", cleanedContent.length);

          // æ£€æŸ¥æ˜¯å¦ç›´æ¥æ˜¯ data URL æ ¼å¼ï¼ˆæœ€å¸¸è§çš„æƒ…å†µï¼‰
          if (cleanedContent.startsWith('data:image/')) {
            console.log("âœ… æ£€æµ‹åˆ°ç›´æ¥çš„data URLæ ¼å¼");
            const match = cleanedContent.match(/^data:image\/([^;]+);base64,(.+)$/);
            if (match) {
              const imageType = match[1];
              const base64String = match[2];
              console.log("ğŸ“Š å›¾ç‰‡ç±»å‹:", imageType, "æ•°æ®é•¿åº¦:", base64String.length);
              
              if (base64String.length < 100) {
                console.warn("âš ï¸ Base64æ•°æ®å¯èƒ½ä¸å®Œæ•´:", base64String.length);
                this.showError("å›¾ç‰‡æ•°æ®ä¸å®Œæ•´ï¼Œè¯·é‡è¯•");
                return;
              }
              
              this.renderImageResult(cleanedContent, imageType, base64String, content);
              return;
            }
          }

          // å°è¯•è§£æ JSON æ ¼å¼çš„å“åº”ï¼ˆæ–°æ ¼å¼ï¼‰
          try {
            const jsonData = JSON.parse(cleanedContent);
            console.log("âœ… æ£€æµ‹åˆ°JSONæ ¼å¼å“åº”");
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«å›¾ç‰‡æ•°æ®
            if (jsonData.content && Array.isArray(jsonData.content)) {
              for (const item of jsonData.content) {
                if (item.type === 'image' && item.source && item.source.data) {
                  console.log("âœ… æ£€æµ‹åˆ°JSONæ ¼å¼çš„å›¾ç‰‡æ•°æ®");
                  
                  const imageType = item.source.media_type.split('/')[1]; // ä¾‹å¦‚: "image/png" -> "png"
                  const base64String = item.source.data;
                  const imageDataUrl = `data:${item.source.media_type};base64,${base64String}`;
                  
                  // éªŒè¯base64æ•°æ®å®Œæ•´æ€§
                  if (base64String.length < 100) {
                    console.warn("âš ï¸ Base64æ•°æ®å¯èƒ½ä¸å®Œæ•´:", base64String.length);
                    this.showError("å›¾ç‰‡æ•°æ®ä¸å®Œæ•´ï¼Œè¯·é‡è¯•");
                    return;
                  }
                  
                  this.renderImageResult(imageDataUrl, imageType, base64String, content);
                  return;
                }
              }
            }
          } catch (e) {
            console.log("ä¸æ˜¯JSONæ ¼å¼ï¼Œå°è¯•Markdownæ ¼å¼è§£æ");
          }

          // æ”¹è¿›çš„ base64 å›¾ç‰‡åŒ¹é…ï¼ˆMarkdownæ ¼å¼ï¼‰ï¼š
          // 1) æ”¾å®½ç©ºç™½åŒ¹é…ï¼›2) é¿å…è´ªå©ªè·¨è¶Šï¼›3) å…¼å®¹å¤§å°å†™ï¼›4) æ”¯æŒå¤šç§å›¾ç‰‡æ ¼å¼
          const base64ImageMatch = cleanedContent.match(
            /!\[image\]\(data:\s*image\/([^;]+);\s*base64,\s*([^)]+)\)/i
          );

          if (base64ImageMatch) {
            console.log("âœ… æ£€æµ‹åˆ°Markdownæ ¼å¼çš„base64å›¾ç‰‡æ•°æ®");

            // æå–å›¾ç‰‡ä¿¡æ¯
            const fullImageData = base64ImageMatch[0];
            const imageType = base64ImageMatch[1];
            // æ¸…ç†å¯èƒ½å‡ºç°çš„æ¢è¡Œæˆ–ç©ºç™½å­—ç¬¦ï¼Œç¡®ä¿ base64 å¯ç”¨
            const base64String = base64ImageMatch[2].replace(/\s+/g, "");
            const imageDataUrl = `data:image/${imageType};base64,${base64String}`;

            // éªŒè¯base64æ•°æ®å®Œæ•´æ€§
            if (base64String.length < 100) {
              console.warn("âš ï¸ Base64æ•°æ®å¯èƒ½ä¸å®Œæ•´:", base64String.length);
              this.showError("å›¾ç‰‡æ•°æ®ä¸å®Œæ•´ï¼Œè¯·é‡è¯•");
              return;
            }
            
            this.renderImageResult(imageDataUrl, imageType, base64String, content);
            return;
          }

          // æ£€æŸ¥è¿”å›å†…å®¹æ˜¯å¦åŒ…å«æ™®é€šå›¾ç‰‡URL
          const imageUrlMatch = content.match(
            /https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|webp)/i
          );

          if (imageUrlMatch) {
            // å¦‚æœè¿”å›çš„æ˜¯å›¾ç‰‡URL
            const imageUrl = imageUrlMatch[0];
            this.resultContainer.innerHTML = `
                        <img src="${imageUrl}" class="result-image" alt="ç¼–è¾‘åçš„å›¾ç‰‡">
                        <div class="image-info">
                            <div class="info-item">
                                <span class="info-label">ç”Ÿæˆæ—¶é—´:</span>
                                <span class="info-value">${new Date().toLocaleString()}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">å›¾ç‰‡é“¾æ¥:</span>
                                <span class="info-value">
                                    <a href="${imageUrl}" target="_blank" style="color: #667eea;">æŸ¥çœ‹åŸå›¾</a>
                                </span>
                            </div>
                        </div>
                    `;
          } else {
            // å¦‚æœè¿”å›çš„æ˜¯æ–‡æœ¬æè¿°ï¼ˆæ”¯æŒæµå¼æ›´æ–°ï¼‰
            this.resultContainer.innerHTML = `
                        <div style="background: #fff; padding: 20px; border-radius: 10px; border: 1px solid #eee;">
                            <h4 style="color: #333; margin-bottom: 15px;">AIåˆ†æç»“æœ:</h4>
                            <div id="streamingContent" style="color: #666; line-height: 1.6; white-space: pre-wrap;">${content}</div>
                            <div class="image-info" style="margin-top: 15px;">
                                <div class="info-item">
                                    <span class="info-label">åˆ†ææ—¶é—´:</span>
                                    <span class="info-value">${new Date().toLocaleString()}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">çŠ¶æ€:</span>
                                    <span class="info-value" style="color: #667eea;">å®æ—¶ç”Ÿæˆä¸­...</span>
                                </div>
                            </div>
                        </div>
                    `;
          }
        }

        updateProcessingStatus(count) {
          // æ›´æ–°å¤„ç†çŠ¶æ€æ˜¾ç¤º
          const statusElement = document.getElementById("streamStatus");
          if (statusElement) {
            statusElement.innerHTML = `ğŸ”„ AIå¤„ç†ä¸­... (${count} æ­¥)`;
            statusElement.style.color = "#667eea";
          }
          
          // æ›´æ–°åŠ è½½æç¤ºä¸­çš„å¤„ç†ä¿¡æ¯
          const processingInfo = document.getElementById("processingInfo");
          if (processingInfo) {
            processingInfo.textContent = `å·²å¤„ç† ${count} ä¸ªæ­¥éª¤...`;
          }
        }

        updateStreamingContent(content, tryRender = true) {
          // åˆå§‹åŒ–æµå¼æ˜¾ç¤ºå®¹å™¨
          if (!document.getElementById("streamingContent")) {
            this.resultContainer.innerHTML = `
               <div style="background: #fff; padding: 20px; border-radius: 10px; border: 1px solid #eee;">
                 <h4 style="color: #333; margin-bottom: 15px;">AIåˆ†æç»“æœ:</h4>
                 <div id="streamingContent" style="color: #666; line-height: 1.6; white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></div>
                 <div class="image-info" style="margin-top: 15px;">
                   <div class="info-item">
                     <span class="info-label">åˆ†ææ—¶é—´:</span>
                     <span class="info-value">${new Date().toLocaleString()}</span>
                   </div>
                   <div class="info-item">
                     <span class="info-label">çŠ¶æ€:</span>
                     <span class="info-value" id="streamStatus" style="color: #667eea;">å®æ—¶ç”Ÿæˆä¸­...</span>
                   </div>
                   <div class="info-item">
                     <span class="info-label">æ•°æ®é•¿åº¦:</span>
                     <span class="info-value" id="contentLength">${
                       content.length
                     } å­—ç¬¦</span>
                   </div>
                 </div>
               </div>
             `;
          }

          // æ›´æ–°æµå¼å†…å®¹
          const streamingElement = document.getElementById("streamingContent");
          const contentLengthElement = document.getElementById("contentLength");

          if (streamingElement) {
            // æ¸…ç†å†…å®¹ï¼ˆç§»é™¤ PROCESSING æ ‡è®°ï¼‰
            const displayContent = content.replace(/:\s*OPENROUTER\s+PROCESSING\s*/gi, '').trim();
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«å›¾ç‰‡æ ‡è®°
            if (displayContent.includes("![image](data:image/")) {
              // æå–å›¾ç‰‡æ ‡è®°çš„ä½ç½®å’Œé•¿åº¦ä¿¡æ¯
              const imageMarkerIndex = displayContent.indexOf("![image](data:image/");
              const estimatedProgress = Math.min(100, Math.round((displayContent.length / 50000) * 100));
              
              streamingElement.innerHTML = `
                 <div style="color: #667eea; font-weight: bold;">ğŸ–¼ï¸ æ£€æµ‹åˆ°å›¾ç‰‡æ•°æ®...</div>
                 <div style="color: #999; font-size: 0.9rem; margin-top: 5px;">æ­£åœ¨æ¥æ”¶å›¾ç‰‡æ•°æ®ï¼Œè¯·ç¨å€™...</div>
                 <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px;">
                   <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">æ•°æ®æ¥æ”¶è¿›åº¦: ${estimatedProgress}%</div>
                   <div style="background: #e9ecef; height: 8px; border-radius: 4px; overflow: hidden;">
                     <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: ${estimatedProgress}%; transition: width 0.3s ease;"></div>
                   </div>
                 </div>
                 <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px; font-family: monospace; font-size: 0.8rem; max-height: 100px; overflow: hidden;">
                   ${displayContent.substring(0, 200)}${displayContent.length > 200 ? "..." : ""}
                 </div>
               `;
            } else if (displayContent.length > 0) {
              streamingElement.innerHTML = `
                 <div style="color: #666; line-height: 1.6; white-space: pre-wrap;">${displayContent}</div>
               `;
            } else {
              streamingElement.innerHTML = `
                 <div style="color: #999; text-align: center; padding: 20px;">
                   <div style="font-size: 2rem; margin-bottom: 10px;">â³</div>
                   <div>ç­‰å¾…AIå“åº”...</div>
                 </div>
               `;
            }

            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            streamingElement.scrollTop = streamingElement.scrollHeight;
          }

          if (contentLengthElement) {
            // æ˜¾ç¤ºæ¸…ç†åçš„å†…å®¹é•¿åº¦
            const cleanLength = content.replace(/:\s*OPENROUTER\s+PROCESSING\s*/gi, '').trim().length;
            contentLengthElement.textContent = `${cleanLength} å­—ç¬¦`;
          }
        }

        finalizeStreamingContent(content) {
          const statusElement = document.getElementById("streamStatus");
          if (statusElement) {
            statusElement.textContent = "è§£æå›¾ç‰‡ä¸­...";
            statusElement.style.color = "#ffc107";
          }

          // åœ¨æµå¼å®Œæˆåè¿›è¡Œæœ€ç»ˆçš„å›¾ç‰‡è§£æå’Œæ¸²æŸ“
          setTimeout(() => {
            this.displayResult(content);
            const finalStatusElement = document.getElementById("streamStatus");
            if (finalStatusElement) {
              finalStatusElement.textContent = "ç”Ÿæˆå®Œæˆ";
              finalStatusElement.style.color = "#28a745";
            }
          }, 500);
        }

        showLoading(show) {
          if (show) {
            this.loading.classList.add("show");
          } else {
            this.loading.classList.remove("show");
          }
        }

        showError(message) {
          // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º <br> æ ‡ç­¾ä»¥æ”¯æŒå¤šè¡Œæ˜¾ç¤º
          this.errorMessage.innerHTML = message.replace(/\n/g, '<br>');
          this.errorMessage.classList.add("show");
          this.successMessage.classList.remove("show");
        }

        showSuccess(message) {
          this.successMessage.textContent = message;
          this.successMessage.classList.add("show");
          this.errorMessage.classList.remove("show");
        }

        hideMessages() {
          this.errorMessage.classList.remove("show");
          this.successMessage.classList.remove("show");
        }

        downloadBase64Image(base64Data, filename) {
          try {
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const link = document.createElement("a");
            link.href = base64Data;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            this.showSuccess("å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼");
          } catch (error) {
            this.showError("ä¸‹è½½å¤±è´¥ï¼š" + error.message);
          }
        }

        copyBase64ToClipboard(base64String) {
          try {
            navigator.clipboard
              .writeText(base64String)
              .then(() => {
                this.showSuccess("Base64æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
              })
              .catch(() => {
                // é™çº§æ–¹æ¡ˆ
                const textArea = document.createElement("textarea");
                textArea.value = base64String;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
                this.showSuccess("Base64æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
              });
          } catch (error) {
            this.showError("å¤åˆ¶å¤±è´¥ï¼š" + error.message);
          }
        }

        showDebugInfo(content, base64String) {
          const modal = document.createElement("div");
          modal.style.cssText = `
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background: rgba(0, 0, 0, 0.8);
             display: flex;
             align-items: center;
             justify-content: center;
             z-index: 10000;
             padding: 20px;
           `;

          const debugPanel = document.createElement("div");
          debugPanel.style.cssText = `
             background: white;
             border-radius: 10px;
             padding: 20px;
             max-width: 80%;
             max-height: 80%;
             overflow-y: auto;
             font-family: monospace;
             font-size: 12px;
           `;

          debugPanel.innerHTML = `
             <h3 style="font-family: sans-serif; margin-bottom: 15px;">ğŸ” è°ƒè¯•ä¿¡æ¯</h3>
             <div style="margin-bottom: 15px;">
               <strong>åŸå§‹å†…å®¹é•¿åº¦:</strong> ${content.length} å­—ç¬¦<br>
               <strong>Base64é•¿åº¦:</strong> ${
                 base64String ? base64String.length : 0
               } å­—ç¬¦<br>
               <strong>é¢„ä¼°å›¾ç‰‡å¤§å°:</strong> ${
                 base64String
                   ? Math.round((base64String.length * 0.75) / 1024)
                   : 0
               } KB
             </div>
             
             <div style="margin-bottom: 15px;">
               <strong>å†…å®¹é¢„è§ˆ (å‰500å­—ç¬¦):</strong>
               <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 5px; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">
${content.substring(0, 500)}${content.length > 500 ? "\n...(å†…å®¹è¢«æˆªæ–­)" : ""}
               </div>
             </div>
             
             ${
               base64String
                 ? `
             <div style="margin-bottom: 15px;">
               <strong>Base64æ•°æ®é¢„è§ˆ (å‰200å­—ç¬¦):</strong>
               <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 5px; word-break: break-all; max-height: 100px; overflow-y: auto;">
${base64String.substring(0, 200)}${
                     base64String.length > 200 ? "...(æ•°æ®è¢«æˆªæ–­)" : ""
                   }
               </div>
             </div>
             `
                 : ""
             }
             
             <div style="text-align: center; margin-top: 20px;">
               <button id="closeDebug" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                 å…³é—­
               </button>
               <button id="copyDebug" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                 å¤åˆ¶è°ƒè¯•ä¿¡æ¯
               </button>
             </div>
           `;

          modal.appendChild(debugPanel);
          document.body.appendChild(modal);

          // ç»‘å®šäº‹ä»¶
          document
            .getElementById("closeDebug")
            .addEventListener("click", () => {
              document.body.removeChild(modal);
            });

          document.getElementById("copyDebug").addEventListener("click", () => {
            const debugText = `
è°ƒè¯•ä¿¡æ¯:
- åŸå§‹å†…å®¹é•¿åº¦: ${content.length} å­—ç¬¦
- Base64é•¿åº¦: ${base64String ? base64String.length : 0} å­—ç¬¦
- é¢„ä¼°å›¾ç‰‡å¤§å°: ${
              base64String ? Math.round((base64String.length * 0.75) / 1024) : 0
            } KB

åŸå§‹å†…å®¹:
${content}
             `;

            navigator.clipboard
              .writeText(debugText)
              .then(() => {
                this.showSuccess("è°ƒè¯•ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
              })
              .catch(() => {
                this.showError("å¤åˆ¶å¤±è´¥");
              });
          });

          // ç‚¹å‡»èƒŒæ™¯å…³é—­
          modal.addEventListener("click", (e) => {
            if (e.target === modal) {
              document.body.removeChild(modal);
            }
          });
        }

        openImagePreview(imageSrc) {
          // åˆ›å»ºé¢„è§ˆæ¨¡æ€æ¡†
          const modal = document.createElement("div");
          modal.style.cssText = `
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background: rgba(0, 0, 0, 0.9);
             display: flex;
             align-items: center;
             justify-content: center;
             z-index: 10000;
             cursor: pointer;
           `;

          const img = document.createElement("img");
          img.src = imageSrc;
          img.style.cssText = `
             max-width: 90%;
             max-height: 90%;
             border-radius: 10px;
             box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
           `;

          const closeBtn = document.createElement("div");
          closeBtn.innerHTML = "âœ•";
          closeBtn.style.cssText = `
             position: absolute;
             top: 20px;
             right: 30px;
             color: white;
             font-size: 30px;
             cursor: pointer;
             background: rgba(0, 0, 0, 0.5);
             width: 40px;
             height: 40px;
             border-radius: 50%;
             display: flex;
             align-items: center;
             justify-content: center;
           `;

          modal.appendChild(img);
          modal.appendChild(closeBtn);
          document.body.appendChild(modal);

          // ç‚¹å‡»å…³é—­
          modal.addEventListener("click", (e) => {
            if (e.target === modal || e.target === closeBtn) {
              document.body.removeChild(modal);
            }
          });

          // ESCé”®å…³é—­
          const handleEsc = (e) => {
            if (e.key === "Escape") {
              document.body.removeChild(modal);
              document.removeEventListener("keydown", handleEsc);
            }
          };
          document.addEventListener("keydown", handleEsc);
        }
      }

      // åˆå§‹åŒ–åº”ç”¨
      document.addEventListener("DOMContentLoaded", () => {
        new ImageEditDemo();
      });
    </script>
  </body>
</html>
