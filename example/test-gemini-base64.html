<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Base64 æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 20px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        textarea {
            min-height: 100px;
            font-family: monospace;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            display: block;
        }
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }
        .preview {
            max-width: 100%;
            margin-top: 10px;
            border-radius: 5px;
        }
        .code {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Gemini Base64 API æµ‹è¯•</h1>
        
        <div class="info">
            <strong>æµ‹è¯•ç›®çš„ï¼š</strong>éªŒè¯ Gemini API ä½¿ç”¨ Base64 å›¾ç‰‡çš„æ­£ç¡®æ ¼å¼<br>
            <strong>å…³é”®ç‚¹ï¼š</strong>ä½¿ç”¨ <code>inline_data</code> è€Œä¸æ˜¯ <code>image_url</code>
        </div>

        <div class="section">
            <label>API Key:</label>
            <input type="text" id="apiKey" value="sk-lBL94e53hHVsiYmemvexQr0Nt4Eg23fkYc2HLV5CPNugUVll">
        </div>

        <div class="section">
            <label>ä¸Šä¼ å›¾ç‰‡:</label>
            <input type="file" id="fileInput" accept="image/*">
            <img id="preview" class="preview" style="display:none;">
        </div>

        <div class="section">
            <label>æç¤ºè¯:</label>
            <input type="text" id="prompt" value="å˜æˆGhibliå¡é€šé£æ ¼" placeholder="ä¾‹å¦‚ï¼šå˜æˆGhibliå¡é€šé£æ ¼">
        </div>

        <div class="section">
            <button id="testBtn" onclick="testAPI()">ğŸš€ æµ‹è¯• API</button>
        </div>

        <div id="result" class="result"></div>

        <div class="section" style="margin-top: 30px;">
            <label>è¯·æ±‚ä½“é¢„è§ˆ:</label>
            <div class="code" id="requestPreview">ä¸Šä¼ å›¾ç‰‡åæ˜¾ç¤º...</div>
        </div>
    </div>

    <script>
        let imageBase64 = '';
        let imageMimeType = '';

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const dataUrl = event.target.result;
                
                // æ˜¾ç¤ºé¢„è§ˆ
                const preview = document.getElementById('preview');
                preview.src = dataUrl;
                preview.style.display = 'block';

                // æå– Base64 å’Œ MIME ç±»å‹
                const matches = dataUrl.match(/^data:([^;]+);base64,(.+)$/);
                if (matches) {
                    imageMimeType = matches[1];
                    imageBase64 = matches[2];
                    
                    updateRequestPreview();
                }
            };
            reader.readAsDataURL(file);
        });

        // æ›´æ–°è¯·æ±‚ä½“é¢„è§ˆ
        function updateRequestPreview() {
            const prompt = document.getElementById('prompt').value || 'å˜æˆGhibliå¡é€šé£æ ¼';
            const requestBody = {
                "contents": [
                    {
                        "parts": [
                            {
                                "text": prompt
                            },
                            {
                                "inline_data": {
                                    "mime_type": imageMimeType,
                                    "data": imageBase64.substring(0, 50) + "..." // åªæ˜¾ç¤ºå‰50ä¸ªå­—ç¬¦
                                }
                            }
                        ]
                    }
                ],
                "generationConfig": {
                    "responseModalities": [
                        "TEXT",
                        "IMAGE"
                    ]
                }
            };

            document.getElementById('requestPreview').textContent = JSON.stringify(requestBody, null, 2);
        }

        // æµ‹è¯• API
        async function testAPI() {
            const resultDiv = document.getElementById('result');
            const testBtn = document.getElementById('testBtn');
            
            // éªŒè¯è¾“å…¥
            if (!imageBase64) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼';
                return;
            }

            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ è¯·è¾“å…¥ API Keyï¼';
                return;
            }

            const prompt = document.getElementById('prompt').value.trim();
            if (!prompt) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ è¯·è¾“å…¥æç¤ºè¯ï¼';
                return;
            }

            // ç¦ç”¨æŒ‰é’®
            testBtn.disabled = true;
            testBtn.textContent = 'â³ æµ‹è¯•ä¸­...';
            resultDiv.className = 'result';
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'æ­£åœ¨è°ƒç”¨ API...';

            try {
                // æ„å»ºè¯·æ±‚ä½“
                const requestBody = {
                    "contents": [
                        {
                            "parts": [
                                {
                                    "text": prompt
                                },
                                {
                                    "inline_data": {
                                        "mime_type": imageMimeType,
                                        "data": imageBase64
                                    }
                                }
                            ]
                        }
                    ],
                    "generationConfig": {
                        "responseModalities": [
                            "TEXT",
                            "IMAGE"
                        ]
                    }
                };

                console.log('ğŸ“¤ å‘é€è¯·æ±‚:', {
                    url: 'https://api.302.ai/google/v1/models/gemini-2.5-flash-image',
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + apiKey.substring(0, 10) + '...',
                        'Content-Type': 'application/json'
                    },
                    bodySize: JSON.stringify(requestBody).length + ' bytes'
                });

                // å‘é€è¯·æ±‚
                const response = await fetch('https://api.302.ai/google/v1/models/gemini-2.5-flash-image', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('ğŸ“¥ æ”¶åˆ°å“åº”:', response.status, response.statusText);

                const data = await response.json();
                console.log('ğŸ“¦ å“åº”æ•°æ®:', data);

                if (!response.ok) {
                    throw new Error(data.error?.message || data.message || `HTTP ${response.status}: ${response.statusText}`);
                }

                // æ˜¾ç¤ºæˆåŠŸç»“æœ
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <strong>âœ… API è°ƒç”¨æˆåŠŸï¼</strong><br><br>
                    <strong>å“åº”çŠ¶æ€:</strong> ${response.status} ${response.statusText}<br>
                    <strong>å“åº”æ•°æ®:</strong><br>
                    <pre style="max-height: 300px; overflow-y: auto; background: white; padding: 10px; border-radius: 5px;">${JSON.stringify(data, null, 2)}</pre>
                `;

                // å¦‚æœæœ‰ç”Ÿæˆçš„å›¾ç‰‡ï¼Œæ˜¾ç¤ºå‡ºæ¥
                if (data.candidates && data.candidates[0]) {
                    const parts = data.candidates[0].content?.parts || [];
                    parts.forEach(part => {
                        if (part.url) {
                            resultDiv.innerHTML += `<br><img src="${part.url}" class="preview" alt="ç”Ÿæˆçš„å›¾ç‰‡">`;
                        } else if (part.inlineData) {
                            const imgSrc = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                            resultDiv.innerHTML += `<br><img src="${imgSrc}" class="preview" alt="ç”Ÿæˆçš„å›¾ç‰‡">`;
                        }
                    });
                }

            } catch (error) {
                console.error('âŒ é”™è¯¯:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <strong>âŒ API è°ƒç”¨å¤±è´¥</strong><br><br>
                    <strong>é”™è¯¯ä¿¡æ¯:</strong> ${error.message}<br><br>
                    <strong>å¯èƒ½åŸå› :</strong><br>
                    â€¢ API Key æ— æ•ˆæˆ–å·²è¿‡æœŸ<br>
                    â€¢ å›¾ç‰‡æ ¼å¼ä¸æ”¯æŒ<br>
                    â€¢ ç½‘ç»œè¿æ¥é—®é¢˜<br>
                    â€¢ API é…é¢å·²ç”¨å®Œ<br><br>
                    <strong>è°ƒè¯•å»ºè®®:</strong><br>
                    1. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°çš„è¯¦ç»†æ—¥å¿—<br>
                    2. éªŒè¯ API Key æ˜¯å¦æ­£ç¡®<br>
                    3. ç¡®è®¤å›¾ç‰‡å¤§å°ä¸è¶…è¿‡é™åˆ¶
                `;
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'ğŸš€ æµ‹è¯• API';
            }
        }

        // æç¤ºè¯è¾“å…¥æ—¶æ›´æ–°é¢„è§ˆ
        document.getElementById('prompt').addEventListener('input', function() {
            if (imageBase64) {
                updateRequestPreview();
            }
        });
    </script>
</body>
</html>

