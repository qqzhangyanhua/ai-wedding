<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµå¼æ•°æ®è§£ææµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #5a67d8;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .error {
            border-left-color: #e53e3e;
            background: #fed7d7;
        }
        .success {
            border-left-color: #38a169;
            background: #c6f6d5;
        }
        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª æµå¼æ•°æ®è§£ææµ‹è¯•</h1>
        <p>æµ‹è¯•ä»test.mdä¸­çš„æµå¼æ•°æ®è§£æbase64å›¾ç‰‡</p>
        
        <div>
            <button class="test-button" onclick="testStreamParsing()">æµ‹è¯•æµå¼è§£æ</button>
            <button class="test-button" onclick="testCompleteData()">æµ‹è¯•å®Œæ•´æ•°æ®</button>
            <button class="test-button" onclick="testIncompleteData()">æµ‹è¯•ä¸å®Œæ•´æ•°æ®</button>
            <button class="test-button" onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        // ä»test.mdä¸­æå–çš„å®é™…æµå¼æ•°æ®
        const streamData = `data: {"id":"chatcmpl-6d688d1068114808979cf8f33562cb24","object":"chat.completion.chunk","created":1760165638,"model":"gemini-2.5-flash-image","system_fingerprint":null,"choices":[{"delta":{"content":"![image](data:image/png;base64,f3iEdmZJUZaezGABFZ+VCzslrBzLGrlBACOQTFyuFQQ4y3xK5YmrlhUIF2PIHpaiejo/DTReQEQM2Ke3tXp6JrWfEhMk2CTMUMm/3B6sI0qVzOrHZzrWAREaRqG0NVRpGeGVlzMwrVGKkoA4xjjAyy2qEyKOUyzCwfeYSgIilkTBu1/o+YixG8NRaSqCLhUkUAEV027HD8dxmV5kOIl1u1euvrW1JhkMVgkdDSkJXONaX0VVlGAXbv67oSaq317hwdx5mRBNxJpJmK4uKwQ+WUZsLaMqmfFjl5owXrtw9f1p1O8eru7nT+6PsfTYd9a3Ztdjyd1XA6nxMzWU0CYKCOvgyYlHgkS5M4gJyRhM/SBgYrC)","role":"assistant"},"logprobs":null,"finish_reason":null,"index":0}],"usage":null}

data: {"id":"chatcmpl-6d688d1068114808979cf8f33562cb24","object":"chat.completion.chunk","created":1760165638,"model":"gemini-2.5-flash-image","system_fingerprint":null,"choices":[{"delta":{},"logprobs":null,"finish_reason":"stop","index":0}],"usage":null}

data: {"id":"chatcmpl-6d688d1068114808979cf8f33562cb24","object":"chat.completion.chunk","created":1760165638,"model":"gemini-2.5-flash-image","system_fingerprint":null,"choices":[],"usage":{"prompt_tokens":3503,"completion_tokens":1290,"total_tokens":4793,"prompt_tokens_details":{"cached_tokens":0,"text_tokens":3503,"audio_tokens":0,"image_tokens":0},"completion_tokens_details":{"text_tokens":0,"audio_tokens":0,"reasoning_tokens":0}}}

data: [DONE]`;

        function addResult(title, content, type = 'result') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `
                <h3>${title}</h3>
                <div>${content}</div>
            `;
            results.appendChild(div);
        }

        function testStreamParsing() {
            addResult('ğŸ”„ å¼€å§‹æµ‹è¯•æµå¼è§£æ', 'æ¨¡æ‹ŸçœŸå®çš„æµå¼æ•°æ®å¤„ç†...');
            
            try {
                // æ¨¡æ‹Ÿæµå¼å¤„ç†
                const lines = streamData.split('\n');
                let content = '';
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.slice(6).trim();
                        if (data === '[DONE]') continue;
                        
                        try {
                            const parsed = JSON.parse(data);
                            if (parsed.choices && parsed.choices[0] && parsed.choices[0].delta && parsed.choices[0].delta.content) {
                                content += parsed.choices[0].delta.content;
                            }
                        } catch (e) {
                            console.warn('è§£æå¤±è´¥:', e);
                        }
                    }
                }
                
                addResult('ğŸ“ æå–çš„å†…å®¹', `<pre>${content}</pre>`);
                
                // æµ‹è¯•æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
                const base64ImageMatch = content.match(/!\[image\]\(data:image\/([^;]+);base64,([^)]+)\)/);
                
                if (base64ImageMatch) {
                    const imageType = base64ImageMatch[1];
                    const base64String = base64ImageMatch[2];
                    
                    addResult('âœ… è§£ææˆåŠŸ', `
                        <strong>å›¾ç‰‡ç±»å‹:</strong> ${imageType}<br>
                        <strong>Base64é•¿åº¦:</strong> ${base64String.length} å­—ç¬¦<br>
                        <strong>é¢„ä¼°å¤§å°:</strong> ${Math.round(base64String.length * 0.75 / 1024)} KB<br>
                        <strong>Base64é¢„è§ˆ:</strong><br>
                        <pre>${base64String.substring(0, 100)}...</pre>
                        <br>
                        <img src="data:image/${imageType};base64,${base64String}" style="max-width: 200px; border: 1px solid #ddd; border-radius: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div style="display: none; color: red; padding: 10px; background: #fee; border-radius: 4px;">å›¾ç‰‡åŠ è½½å¤±è´¥ - Base64æ•°æ®å¯èƒ½ä¸å®Œæ•´æˆ–æŸå</div>
                    `, 'success');
                } else {
                    addResult('âŒ è§£æå¤±è´¥', 'æœªèƒ½åŒ¹é…åˆ°base64å›¾ç‰‡æ•°æ®', 'error');
                }
                
            } catch (error) {
                addResult('âŒ æµ‹è¯•å¤±è´¥', `é”™è¯¯: ${error.message}`, 'error');
            }
        }

        function testCompleteData() {
            // åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„base64å›¾ç‰‡æ•°æ®è¿›è¡Œæµ‹è¯•
            const completeBase64 = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
            const testContent = `![image](data:image/png;base64,${completeBase64})`;
            
            addResult('ğŸ§ª æµ‹è¯•å®Œæ•´æ•°æ®', 'ä½¿ç”¨ä¸€ä¸ªæœ‰æ•ˆçš„1x1åƒç´ PNGå›¾ç‰‡');
            
            const base64ImageMatch = testContent.match(/!\[image\]\(data:image\/([^;]+);base64,([^)]+)\)/);
            
            if (base64ImageMatch) {
                const imageType = base64ImageMatch[1];
                const base64String = base64ImageMatch[2];
                
                addResult('âœ… å®Œæ•´æ•°æ®æµ‹è¯•æˆåŠŸ', `
                    <strong>å›¾ç‰‡ç±»å‹:</strong> ${imageType}<br>
                    <strong>Base64é•¿åº¦:</strong> ${base64String.length} å­—ç¬¦<br>
                    <strong>é¢„ä¼°å¤§å°:</strong> ${Math.round(base64String.length * 0.75 / 1024)} KB<br>
                    <br>
                    <img src="data:image/${imageType};base64,${base64String}" style="max-width: 200px; border: 1px solid #ddd; border-radius: 4px; background: #f0f0f0;">
                `, 'success');
            }
        }

        function testIncompleteData() {
            const incompleteContent = '![image](data:image/png;base64,f3iEdmZJUZaezGABFZ+VCzslrBzLGrlBACOQTFyuFQQ4y3xK5YmrlhUIF2PIHpaiejo/DTReQEQM2Ke3tXp6JrWfEhMk2CTMUMm/3B6sI0qVzOrHZzrWAREaRqG0NVRpGeGVlzMwrVGKkoA4xjjAyy2qEyKOUyzCwfeYSgIilkTBu1/o+YixG8NRaSqCLhUkUAEV027HD8dxmV5kOIl1u1euvrW1JhkMVgkdDSkJXONaX0VVlGAXbv67oSaq317hwdx5mRBNxJpJmK4uKwQ+WUZsLaMqmfFjl5owXrtw9f1p1O8eru7nT+6PsfTYd9a3Ztdjyd1XA6nxMzWU0CYKCOvgyYlHgkS5M4gJyRhM/SBgYrC';
            
            addResult('ğŸ§ª æµ‹è¯•ä¸å®Œæ•´æ•°æ®', 'ä½¿ç”¨æˆªæ–­çš„base64æ•°æ®ï¼ˆç¼ºå°‘ç»“å°¾ï¼‰');
            
            const base64ImageMatch = incompleteContent.match(/!\[image\]\(data:image\/([^;]+);base64,([^)]+)\)/);
            
            if (base64ImageMatch) {
                const imageType = base64ImageMatch[1];
                const base64String = base64ImageMatch[2];
                
                addResult('âš ï¸ æ£€æµ‹åˆ°ä¸å®Œæ•´æ•°æ®', `
                    <strong>å›¾ç‰‡ç±»å‹:</strong> ${imageType}<br>
                    <strong>Base64é•¿åº¦:</strong> ${base64String.length} å­—ç¬¦<br>
                    <strong>é¢„ä¼°å¤§å°:</strong> ${Math.round(base64String.length * 0.75 / 1024)} KB<br>
                    <strong>é—®é¢˜:</strong> æ•°æ®ä¸å®Œæ•´ï¼Œç¼ºå°‘ç»“å°¾çš„ ")" ç¬¦å·<br>
                    <br>
                    <img src="data:image/${imageType};base64,${base64String}" style="max-width: 200px; border: 1px solid #ddd; border-radius: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div style="display: none; color: red; padding: 10px; background: #fee; border-radius: 4px;">âŒ å›¾ç‰‡åŠ è½½å¤±è´¥ - Base64æ•°æ®ä¸å®Œæ•´</div>
                `, 'error');
            } else {
                addResult('âŒ æ— æ³•åŒ¹é…', 'æ­£åˆ™è¡¨è¾¾å¼æ— æ³•åŒ¹é…ä¸å®Œæ•´çš„æ•°æ®', 'error');
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            addResult('ğŸ“‹ æµ‹è¯•è¯´æ˜', `
                è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•æµå¼æ•°æ®ä¸­base64å›¾ç‰‡çš„è§£æã€‚<br>
                <strong>é—®é¢˜åˆ†æ:</strong><br>
                1. test.mdä¸­çš„base64æ•°æ®è¢«æˆªæ–­äº†ï¼ˆç¼ºå°‘ç»“å°¾çš„ ")" ç¬¦å·ï¼‰<br>
                2. æµå¼ä¼ è¾“ä¸­ï¼Œæ•°æ®å¯èƒ½åˆ†æ•£åœ¨å¤šä¸ªchunkä¸­<br>
                3. éœ€è¦ç­‰å¾…å®Œæ•´æ•°æ®æ¥æ”¶å®Œæ¯•å†è¿›è¡Œè§£æ<br><br>
                <strong>è§£å†³æ–¹æ¡ˆ:</strong><br>
                1. æ”¹è¿›æµå¼å¤„ç†é€»è¾‘ï¼Œåªåœ¨å®Œæˆæ—¶è§£æå›¾ç‰‡<br>
                2. æ·»åŠ æ•°æ®å®Œæ•´æ€§éªŒè¯<br>
                3. æä¾›è°ƒè¯•ä¿¡æ¯å¸®åŠ©è¯Šæ–­é—®é¢˜
            `);
        });
    </script>
</body>
</html>
